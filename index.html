<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë¸”ë¡ ì½”ë”© â†’ BLE ì‹¤ì‹œê°„ ì œì–´ (MX-01/ESP32 ì§€ì›)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Blockly CDN -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    :root { --pad: 10px; }
    body { margin:0; font-family:system-ui, sans-serif; }
    header { padding: var(--pad); display:flex; gap:8px; align-items:center; flex-wrap:wrap; border-bottom:1px solid #eee; }
    button, input { font-size: 14px; padding: 8px 12px; border-radius:10px; border:1px solid #ddd; }
    button { border:0; cursor:pointer; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    #connect { background:#2563eb; color:#fff; }
    #disconnect { background:#64748b; color:#fff; }
    #run { background:#16a34a; color:#fff; }
    #stop { background:#ef4444; color:#fff; }
    .status { margin-left: auto; font-size:12px; background:#eee; border-radius:999px; padding:4px 10px; }
    .ok { background:#d1fae5; }
    #main { display:flex; height: calc(100vh - 70px); }
    #blocklyDiv { flex: 1 1 60%; height:100%; }
    #right { flex:1 1 40%; border-left:1px solid #eee; padding: var(--pad); display:flex; flex-direction:column; gap:10px; }
    #log { flex: 1 1 auto; white-space:pre-wrap; background:#f7f7f7; border-radius:10px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; overflow:auto; }
    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <header>
    <strong>ë¸”ë¡ ì½”ë”© â†’ BLE ì œì–´</strong>
    <input id="devName" placeholder="ë‚´ ê¸°ê¸° ì´ë¦„(ì˜ˆ: MX-AB12)" />
    <button id="connect">ğŸ”— ì—°ê²°</button>
    <button id="disconnect" disabled>âŒ í•´ì œ</button>
    <button id="run" disabled>â–¶ ì‹¤í–‰</button>
    <button id="stop" disabled>â–  ì •ì§€</button>
    <span id="status" class="status">ë¯¸ì—°ê²°</span>
  </header>
  <div id="main">
    <div id="blocklyDiv"></div>
    <div id="right">
      <div>
        <div class="small">ì„œë¹„ìŠ¤/íŠ¹ì„± UUIDëŠ” MX-01 ê¸°ë³¸ê°’(ì„œë¹„ìŠ¤ 0xFFF0)ì„ ìš°ì„  ì‹œë„í•˜ê³ , ëª» ì°¾ìœ¼ë©´ ìë™ íƒì§€í•©ë‹ˆë‹¤.</div>
        <div class="small">ëª…ë ¹ í¬ë§·(ê¸°ë³¸): <code>M a b</code> (ëª¨í„°1,2 ì†ë„), <code>W ms</code> (ê¸°ë‹¤ë¦¬ê¸°), <code>S</code> (ì •ì§€)</div>
      </div>
      <div id="log"></div>
    </div>
  </div>

  <!-- íˆ´ë°•ìŠ¤(ë¸”ë¡ ì¹´í…Œê³ ë¦¬) -->
  <xml id="toolbox" style="display:none">
    <category name="ë¡œë´‡" colour="#0ea5e9">
      <block type="motor12speed"></block>
      <block type="wait_seconds"></block>
      <block type="stop_motors"></block>
      <block type="repeat_times"></block>
      <block type="repeat_forever"></block>
    </category>
    <category name="ê°’" colour="#f59e0b">
      <block type="math_number"><field name="NUM">20</field></block>
      <block type="math_number"><field name="NUM">1</field></block>
      <block type="math_number"><field name="NUM">0</field></block>
    </category>
    <category name="ë…¼ë¦¬" colour="#10b981">
      <block type="controls_if"></block>
    </category>
  </xml>

  <script>
    // ------------- Blockly ì›Œí¬ìŠ¤í˜ì´ìŠ¤ -------------
    const ws = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      grid: { spacing: 20, length: 3, colour: '#eee', snap: true },
      zoom: { controls: true, wheel: true }
    });

    // ì»¤ìŠ¤í…€ ë¸”ë¡ ì •ì˜
    Blockly.defineBlocksWithJsonArray([
      {
        "type": "motor12speed",
        "message0": "ëª¨í„° ì†ë„ M1 %1 M2 %2",
        "args0": [
          { "type":"input_value", "name":"M1", "check":"Number" },
          { "type":"input_value", "name":"M2", "check":"Number" }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 210,
        "tooltip": "ëª¨í„°1,2 ì†ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤(ì˜ˆ: 20, 20).",
        "helpUrl": ""
      },
      {
        "type": "wait_seconds",
        "message0": "%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
        "args0": [{ "type":"input_value", "name":"SEC", "check":"Number" }],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 65,
        "tooltip": "ì§€ì •í•œ ì‹œê°„(ì´ˆ) ê¸°ë‹¤ë¦½ë‹ˆë‹¤.",
        "helpUrl": ""
      },
      {
        "type": "stop_motors",
        "message0": "ëª¨í„° ì •ì§€",
        "previousStatement": null,
        "nextStatement": null,
        "colour": 0,
        "tooltip": "ëª¨ë“  ëª¨í„° ì •ì§€(S ëª…ë ¹).",
        "helpUrl": ""
      },
      {
        "type":"repeat_times",
        "message0":"%1 ë²ˆ ë°˜ë³µ %2 %3",
        "args0":[
          {"type":"input_value","name":"COUNT","check":"Number"},
          {"type":"input_statement","name":"DO"},
          {"type":"input_dummy"}
        ],
        "previousStatement":null,
        "nextStatement":null,
        "colour":120,
        "tooltip":"ì •í•´ì§„ íšŸìˆ˜ë§Œí¼ ë¸”ë¡ì„ ë°˜ë³µí•©ë‹ˆë‹¤."
      },
      {
        "type":"repeat_forever",
        "message0":"ê³„ì† ë°˜ë³µ %1 %2",
        "args0":[
          {"type":"input_statement","name":"DO"},
          {"type":"input_dummy"}
        ],
        "previousStatement":null,
        "nextStatement":null,
        "colour":120,
        "tooltip":"ì •ì§€ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œê¹Œì§€ ê³„ì† ë°˜ë³µí•©ë‹ˆë‹¤."
      }
    ]);

    // ê°„ë‹¨í•œ â€œëª…ë ¹ ë¦¬ìŠ¤íŠ¸â€ ìƒì„±ê¸°
    // ê° ë¸”ë¡ì„ {type:'M'|'W'|'S'|'LOOP'..., args:[...]} í˜•íƒœë¡œ ë³€í™˜
    function blocksToProgram() {
      const topBlocks = ws.getTopBlocks(true);
      // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì—°ê²°ëœ ìŠ¤íƒë§Œ ì‹¤í–‰í•˜ë„ë¡, ì²« ë²ˆì§¸ Statement stackì„ ìˆ˜ì§‘
      let start = null;
      for (const b of topBlocks) {
        if (b.previousConnection || b.nextConnection || b.statementInputCount) { start = b; break; }
      }
      if (!start) return [];

      const prog = [];
      function walk(block) {
        if (!block) return;
        switch(block.type) {
          case 'motor12speed': {
            const m1 = Blockly.JavaScript.valueToCode(block,'M1',Blockly.JavaScript.ORDER_NONE) || '0';
            const m2 = Blockly.JavaScript.valueToCode(block,'M2',Blockly.JavaScript.ORDER_NONE) || '0';
            prog.push({type:'M', args:[Number(m1), Number(m2)]});
            break;
          }
          case 'wait_seconds': {
            const s = Blockly.JavaScript.valueToCode(block,'SEC',Blockly.JavaScript.ORDER_NONE) || '0';
            prog.push({type:'W', args:[Math.max(0, Number(s)*1000)]}); // ms
            break;
          }
          case 'stop_motors':
            prog.push({type:'S', args:[]});
            break;
          case 'repeat_times': {
            const c = Blockly.JavaScript.valueToCode(block,'COUNT',Blockly.JavaScript.ORDER_NONE) || '1';
            const count = Math.max(0, parseInt(c));
            const inner = [];
            // í•˜ìœ„ ìŠ¤íƒ ìˆ˜ì§‘
            let child = block.getInputTargetBlock('DO');
            while (child) { collect(child, inner); child = child.getNextBlock(); }
            prog.push({type:'LOOP_N', n:count, body:inner});
            break;
          }
          case 'repeat_forever': {
            const inner = [];
            let child = block.getInputTargetBlock('DO');
            while (child) { collect(child, inner); child = child.getNextBlock(); }
            prog.push({type:'LOOP_INF', body:inner});
            break;
          }
        }
        walk(block.getNextBlock());
      }
      function collect(b, list) {
        // ë¸”ë¡ subtreeë¥¼ ë¦¬ìŠ¤íŠ¸ì— push
        switch(b.type) {
          case 'motor12speed': {
            const m1 = Blockly.JavaScript.valueToCode(b,'M1',Blockly.JavaScript.ORDER_NONE) || '0';
            const m2 = Blockly.JavaScript.valueToCode(b,'M2',Blockly.JavaScript.ORDER_NONE) || '0';
            list.push({type:'M', args:[Number(m1), Number(m2)]});
            break;
          }
          case 'wait_seconds': {
            const s = Blockly.JavaScript.valueToCode(b,'SEC',Blockly.JavaScript.ORDER_NONE) || '0';
            list.push({type:'W', args:[Math.max(0, Number(s)*1000)]});
            break;
          }
          case 'stop_motors': list.push({type:'S', args:[]}); break;
          case 'repeat_times': {
            const c = Blockly.JavaScript.valueToCode(b,'COUNT',Blockly.JavaScript.ORDER_NONE) || '1';
            const count = Math.max(0, parseInt(c));
            const inner=[]; let child=b.getInputTargetBlock('DO');
            while (child) { collect(child, inner); child = child.getNextBlock(); }
            list.push({type:'LOOP_N', n:count, body:inner});
            break;
          }
          case 'repeat_forever': {
            const inner=[]; let child=b.getInputTargetBlock('DO');
            while (child) { collect(child, inner); child = child.getNextBlock(); }
            list.push({type:'LOOP_INF', body:inner});
            break;
          }
        }
      }
      walk(start);
      return prog;
    }

    // ------------- Web Bluetooth -------------
    const SERVICE_UUID = 0xFFF0; // MX-01 ê¸°ë³¸ ì„œë¹„ìŠ¤ (ë³€í˜• íŒì›¨ì–´ëŠ” ìë™íƒì§€ë¡œ ì»¤ë²„)
    let bleDevice=null, bleServer=null, bleService=null, writeChar=null, notifyChar=null;
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    const log = (m)=>{ logEl.textContent += m+"\n"; logEl.scrollTop=logEl.scrollHeight; }
    const setUI = (on)=>{
      document.getElementById('disconnect').disabled = !on;
      document.getElementById('run').disabled = !on;
      document.getElementById('stop').disabled = !on;
      statusEl.textContent = on ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°';
      statusEl.className = on ? 'status ok' : 'status';
    };

    function enc(s){ return new TextEncoder().encode(s); }

    async function connectBLE(){
      const wanted = document.getElementById('devName').value.trim();
      if (!navigator.bluetooth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetooth ë¯¸ì§€ì›ì…ë‹ˆë‹¤.');
      try{
        log('â³ ìŠ¤ìº” ì¤‘...');
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID],
        });
        if (wanted && device.name !== wanted) {
          log(`ì„ íƒëœ ê¸°ê¸° ì´ë¦„ì´ ë‹¤ë¦…ë‹ˆë‹¤: ${device.name||'(ì—†ìŒ)'} â†’ ì·¨ì†Œ.`);
          alert('íŒì—…ì—ì„œ ë³¸ì¸ ê¸°ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”!');
          return;
        }
        bleDevice = device;
        bleDevice.addEventListener('gattserverdisconnected', ()=>{ setUI(false); log('ğŸ”Œ í•´ì œë¨'); });

        bleServer = await bleDevice.gatt.connect();
        bleService = await bleServer.getPrimaryService(SERVICE_UUID);
        // ìš°ì„  FFF3/FFF4 ì‹œë„
        try{ writeChar = await bleService.getCharacteristic(0xFFF3); }catch(_){}
        try{ notifyChar= await bleService.getCharacteristic(0xFFF4); }catch(_){}
        // ìë™ íƒì§€
        if(!writeChar || notifyChar==null){
          const chars = await bleService.getCharacteristics();
          for (const ch of chars) {
            const p = ch.properties;
            if (!writeChar && (p.write || p.writeWithoutResponse)) writeChar = ch;
            if (!notifyChar && p.notify) notifyChar = ch;
          }
        }
        if (!writeChar) throw new Error('write íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

        if (notifyChar) {
          await notifyChar.startNotifications();
          notifyChar.addEventListener('characteristicvaluechanged', ev=>{
            const v = new TextDecoder().decode(ev.target.value);
            log('â¬…ï¸ Notify: '+v);
          });
        }
        setUI(true);
        log(`âœ… ì—°ê²° ì„±ê³µ: ${device.name || '(ì´ë¦„ ì—†ìŒ)'}`);
      }catch(e){
        console.error(e); log('âŒ ì—°ê²° ì‹¤íŒ¨: '+e); setUI(false);
      }
    }

    function disconnectBLE(){
      try { bleDevice?.gatt?.disconnect(); } catch(_) {}
      setUI(false);
    }

    async function sendCmd(cmdStr){
      if (!writeChar) throw new Error('BLE ë¯¸ì—°ê²°');
      // MX-01ì€ íˆ¬ëª…ì „ì†¡ UART â†’ ì§§ì€ í…ìŠ¤íŠ¸ ê¶Œì¥
      await writeChar.writeValue(enc(cmdStr+'\n'));
      log('â¡ï¸ '+cmdStr);
    }

    // ------------- ì‹¤í–‰ê¸°(ì¸í„°í”„ë¦¬í„°) -------------
    let running = false;

    async function runProgram(){
      if (!writeChar) return alert('ë¨¼ì € BLE ì—°ê²°!');
      const prog = blocksToProgram();
      if (!prog.length) return alert('ì‹¤í–‰í•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
      running = true; document.getElementById('stop').disabled = false;

      // ëª…ë ¹ ì‹¤í–‰ (LOOP/WAIT ì§€ì›)
      async function execList(list){
        for (let i=0; i<list.length && running; i++){
          const instr = list[i];
          if (instr.type==='M'){
            const [a,b] = instr.args;
            await sendCmd(`M ${Math.round(a)} ${Math.round(b)}`);
          } else if (instr.type==='W'){
            const [ms] = instr.args;
            await new Promise(r=>setTimeout(r, ms));
          } else if (instr.type==='S'){
            await sendCmd('S');
          } else if (instr.type==='LOOP_N'){
            for (let k=0; k<instr.n && running; k++){
              await execList(instr.body);
            }
          } else if (instr.type==='LOOP_INF'){
            while (running){
              await execList(instr.body);
            }
          }
        }
      }

      try{ await execList(prog); }
      catch(e){ console.error(e); log('âš ï¸ ì‹¤í–‰ ì˜¤ë¥˜: '+e); }
      running = false; document.getElementById('stop').disabled = true;
    }

    function stopProgram(){
      running = false;
      // ì•ˆì „ ì •ì§€ ëª…ë ¹ ì „ì†¡
      if (writeChar) sendCmd('S').catch(()=>{});
    }

    // UI ë°”ì¸ë”©
    document.getElementById('connect').onclick = connectBLE;
    document.getElementById('disconnect').onclick = disconnectBLE;
    document.getElementById('run').onclick = runProgram;
    document.getElementById('stop').onclick = stopProgram;

    setUI(false);

    // ì‹œì‘ í…œí”Œë¦¿ ë°°ì¹˜(ì˜ˆ: M 20 20 â†’ 1ì´ˆ â†’ M 0 0 â†’ 1ì´ˆ ë°˜ë³µ)
    const xmlText = `
      <xml xmlns="https://developers.google.com/blockly/xml">
        <block type="repeat_forever" x="30" y="30">
          <statement name="DO">
            <block type="motor12speed">
              <value name="M1"><block type="math_number"><field name="NUM">20</field></block></value>
              <value name="M2"><block type="math_number"><field name="NUM">20</field></block></value>
              <next>
                <block type="wait_seconds">
                  <value name="SEC"><block type="math_number"><field name="NUM">1</field></block></value>
                  <next>
                    <block type="motor12speed">
                      <value name="M1"><block type="math_number"><field name="NUM">0</field></block></value>
                      <value name="M2"><block type="math_number"><field name="NUM">0</field></block></value>
                      <next>
                        <block type="wait_seconds">
                          <value name="SEC"><block type="math_number"><field name="NUM">1</field></block></value>
                        </block>
                      </next>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </statement>
        </block>
      </xml>`;
    const dom = Blockly.utils.xml.textToDom(xmlText);
    Blockly.Xml.domToWorkspace(dom, ws);
  </script>
</body>
</html>
