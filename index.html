<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO Î∏îÎ°ù ÏΩîÎî© ‚Üí BLE + ÏΩîÎìúÎ∑∞ (XROBO ÌïÑÌÑ∞ + Ïû¨Ïó∞Í≤∞ Î≤ÑÍ∑∏ ÏàòÏ†ï)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  :root{ --pad:10px; --uiScale:1; --headerBase:70; }
  *{ box-sizing:border-box; } body{ margin:0; font-family:system-ui, sans-serif; }

  /* Ìó§Îçî */
  header{ padding:var(--pad); border-bottom:1px solid #eee; background:#fff; position:relative; z-index:10;
          height: calc( var(--headerBase) * var(--uiScale) * 1px ); }
  #headerInner{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; transform-origin:top left; transform:scale(var(--uiScale)); }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; } .grow{ flex:1 1 auto; }
  button{ font-size:14px; padding:8px 12px; border-radius:10px; border:0; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.08); transition:background .15s; }
  #connectToggle{ background:#2563eb; color:#fff; }
  #runToggle{ background:#16a34a; color:#fff; }
  #fsBtn{ background:#111827; color:#fff; }
  .hint{ font-size:12px; color:#6b7280; }

  /* on/off ÎèôÍ∑∏ÎùºÎØ∏ */
  .state{ display:inline-flex; align-items:center; gap:8px; font-size:12px; }
  .badgeDot{ width:22px; height:22px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
             font-weight:700; color:#fff; user-select:none; box-shadow:0 0 0 4px rgba(0,0,0,.06) inset;}
  .badgeDot.on{ background:#3b82f6;} .badgeDot.off{ background:#ef4444;}

  /* Î≥∏Î¨∏ */
  #main{ display:flex; height: calc(100vh - (var(--headerBase) * var(--uiScale) * 1px)); width:100%; }
  #left{ position:relative; flex:1 1 auto; min-width:0; height:100%; display:flex; }
  #blocklyDiv{ flex:1 1 auto; min-width:0; height:100%; width:100%; }

  /* Ïò§Î•∏Ï™Ω Ìå®ÎÑê */
  #right{ flex:0 0 40%; display:flex; flex-direction:column; margin:8px 8px 8px 0;
          background:#fff; border:1px solid #e5e7eb; border-left:3px solid #60a5fa; border-radius:12px 0 0 12px; box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden; }
  #rightTop{ flex:3 1 0; border-bottom:1px solid #e5e7eb; background:#f5f7fa; color:#111827;
             font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
             font-size:13px; line-height:1.45; padding:12px; overflow:auto; white-space:pre; tab-size:2; }
  #rightBottom{ flex:1 1 0; padding:var(--pad); background:#0b0f14; color:#d1e4ff; }
  #log{ height:100%; white-space:pre-wrap; background:#0b0f14; border:1px solid #1f2937; border-radius:8px; padding:10px;
        font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; overflow:auto; color:#d1e4ff; }
  .small{ font-size:12px; color:#9ca3af; }

  body.fs-active #main{ height: calc(100vh - (var(--headerBase) * var(--uiScale) * 1px)); }
  body.panel-collapsed #right{ display:none; } body.panel-collapsed #left{ flex:1 1 100%; }

  /* Ïã§ÌñâÏ∞Ω ÌÜ†Í∏Ä */
  #panelToggle{ position:absolute; right:10px; top:10px; z-index:9999; background:#111827; color:#fff; border-radius:12px; padding:8px 10px;
                transform-origin:top right; transform:scale(var(--uiScale)); }

  .blocklyZoom,.blocklyTrash{ display:block !important; }
</style>
</head>
<body>
  <header id="appHeader">
    <div id="headerInner">
      <div class="row"><strong>XROBO Î∏îÎ°ù ‚Üí BLE + ÏΩîÎìúÎ∑∞</strong> <span class="hint">Ïó∞Í≤∞ Ïãú Î∏åÎùºÏö∞Ï†Ä ÌåùÏóÖÏóê <b>XROBO*</b> Ïû•ÏπòÎßå ÌëúÏãúÎê©ÎãàÎã§.</span></div>
      <div class="row grow">
        <button id="connectToggle">Ïó∞Í≤∞</button>
        <button id="runToggle" disabled>‚ñ∂ Ïã§Ìñâ</button>
        <span class="state"><span id="statusDot" class="badgeDot off">off</span></span>
        <button id="fsBtn" title="Ï†ÑÏ≤¥ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò">üñµ Ï†ÑÏ≤¥ÌôîÎ©¥</button>
      </div>
    </div>
  </header>

  <div id="main">
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelToggle" title="Ïã§ÌñâÏ∞Ω Ïó¥Í∏∞/Îã´Í∏∞">‚ñ∂ Ïã§ÌñâÏ∞Ω Îã´Í∏∞</button>
    </div>
    <div id="right">
      <div id="rightTop"></div>
      <div id="rightBottom">
        <div class="small">Ïã§Ìñâ Î°úÍ∑∏</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- Ìà¥Î∞ïÏä§ -->
  <xml id="toolbox" style="display:none">
    <category name="Ïù¥Î≤§Ìä∏" colour="#f59e0b"><block type="xrobo_start"></block></category>

    <category name="ÏûÖÎ†•" colour="#06b6d4">
      <block type="in_xkeypad"><field name="PIN">IN1</field><field name="BTN">B1</field></block>
      <block type="in_ir_dist"><field name="PIN">IN1</field><value name="DIST"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="in_touch"><field name="PIN">IN1</field></block>
    </category>

    <category name="Ï∂úÎ†•" colour="#60a5fa">
      <block type="motor12_dd"><field name="M1">20</field><field name="M2">20</field><field name="MS">500</field></block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="motor34_dd"><field name="M3">20</field><field name="M4">20</field><field name="MS">500</field></block>
      <block type="motor34_in">
        <value name="M3"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M4"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="servo_dd"><field name="OUT">OUT1</field><field name="ANG">90</field></block>
      <block type="servo_in"><field name="OUT">OUT1</field><value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>
      <block type="servo_slow"><field name="OUT">OUT1</field><value name="DELAY"><shadow type="math_number"><field name="NUM">5</field></shadow></value><value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>

      <block type="melody"><field name="PITCH">C4</field><value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value><value name="WAIT"><shadow type="math_number"><field name="NUM">250</field></shadow></value></block>
      <block type="led_ctrl"><field name="TGT">OUT1</field><field name="MODE">BRIGHT</field><field name="VAL">10</field></block>
    </category>

    <category name="Ï†úÏñ¥" colour="#10b981">
      <block type="repeat_forever"></block>
      <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>
      <block type="controls_if"></block>
      <block type="controls_if"><mutation else="1"></mutation></block>
      <block type="wait_seconds"><value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
      <block type="control_wait_until"></block>
      <block type="control_repeat_until"></block>
    </category>

    <category name="Ïó∞ÏÇ∞" colour="#a78bfa">
      <block type="math_arithmetic"><value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">2</field></shadow></value></block>
      <block type="logic_compare"><value name="A"><shadow type="math_number"><field name="NUM">10</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">5</field></shadow></value></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="math_random_int"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="math_number"><field name="NUM">20</field></block>
      <block type="math_number"><field name="NUM">500</field></block>
    </category>

    <category name="Î≥ÄÏàò" colour="#f97316" custom="VARIABLE"></category>
    <category name="ÎÇ¥Î∏îÎ°ù" colour="#ef4444" custom="PROCEDURE"></category>
  </xml>

  <script>
    /* ‚îÄ‚îÄ Zelos Ìï¥Ìä∏ Í∞ïÏ†ú Î†åÎçîÎü¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    class XroboZelosProvider extends Blockly.zelos.ConstantProvider {
      constructor(){ super(); this.ADD_START_HATS = true; }
    }
    class XroboZelosRenderer extends Blockly.zelos.Renderer {
      constructor(){ super('xrobo_zelos'); }
      makeConstants_(){ return new XroboZelosProvider(); }
    }
    Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);

    /* ÌÖåÎßà */
    const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', { base: Blockly.Themes.Zelos, componentStyles: { startHats: true } });

    /* Blockly Ï£ºÏûÖ */
    const ws = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      renderer: 'xrobo_zelos', theme: XroboTheme,
      grid: { spacing:20, length:3, colour:'#eee', snap:true }, zoom: { controls:true, wheel:true }
    });

    /* ‚îÄ‚îÄ Î∏îÎ°ù Ï†ïÏùò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const PINS_IN=[["IN1","IN1"],["IN2","IN2"],["IN3","IN3"],["IN4","IN4"]];
    const PINS_OUT=[["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
    const KEYS_B=[["B1","B1"],["B2","B2"],["B3","B3"],["B4","B4"],["B5","B5"]];
    const SPEEDS=Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
    const TIMES100=Array.from({length:10},(_,i)=>(100*(i+1))).map(v=>[String(v),String(v)]);
    const ANG_5=Array.from({length:37},(_,i)=>i*5).map(v=>[String(v),String(v)]);
    const LED_TGT=[...PINS_OUT,["CPU","CPU"]];
    const LED_MODE=[["Î∞ùÍ∏∞","BRIGHT"],["Ïà®Ïâ¨Í∏∞","BREATHE"]];
    const LED_VALS=Array.from({length:20},(_,i)=>[String(i),String(i)]);
    const PITCHES=(()=>{const KR=["ÎèÑ","Î†à","ÎØ∏","Ìåå","ÏÜî","Îùº","Ïãú"],EN=["C","D","E","F","G","A","B"],L=[];for(let o=4;o<=6;o++)for(let i=0;i<7;i++)L.push([`${KR[i]}${o}`,`${EN[i]}${o}`]);return L;})();

    Blockly.defineBlocksWithJsonArray([
      { "type":"xrobo_start", "message0":"XROBO start", "nextStatement":null, "colour":36, "hat":"cap" },

      { "type":"in_xkeypad", "message0":"X ÌÇ§Ìå®Îìú ÌïÄ %1 Î≤ÑÌäº %2",
        "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN},{"type":"field_dropdown","name":"BTN","options":KEYS_B}],
        "output":"Boolean","colour":198 },
      { "type":"in_ir_dist", "message0":"Ï†ÅÏô∏ÏÑ†ÏÑºÏÑú ÌïÄ %1 Í±∞Î¶¨ %2 Ïù¥ÎÇ¥",
        "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN},{"type":"input_value","name":"DIST","check":"Number"}],
        "output":"Boolean","colour":198 },
      { "type":"in_touch", "message0":"Ï†ëÏ¥âÏÑºÏÑú ÌïÄ %1 ÎàåÎ¶º",
        "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN}],
        "output":"Boolean","colour":198 },

      { "type":"motor12_dd","message0":"Î™®ÌÑ∞ M1 %1  M2 %2  ÏãúÍ∞Ñ %3 ms",
        "args0":[{"type":"field_dropdown","name":"M1","options":SPEEDS},{"type":"field_dropdown","name":"M2","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
      { "type":"motor12_in","message0":"Î™®ÌÑ∞ M1 %1  M2 %2  ÏãúÍ∞Ñ %3 ms",
        "args0":[{"type":"input_value","name":"M1","check":"Number"},{"type":"input_value","name":"M2","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

      { "type":"motor34_dd","message0":"Î™®ÌÑ∞ M3 %1  M4 %2  ÏãúÍ∞Ñ %3 ms",
        "args0":[{"type":"field_dropdown","name":"M3","options":SPEEDS},{"type":"field_dropdown","name":"M4","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
      { "type":"motor34_in","message0":"Î™®ÌÑ∞ M3 %1  M4 %2  ÏãúÍ∞Ñ %3 ms",
        "args0":[{"type":"input_value","name":"M3","check":"Number"},{"type":"input_value","name":"M4","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

      { "type":"servo_dd","message0":"ÏÑúÎ≥¥Î™®ÌÑ∞ %1 Í∞ÅÎèÑ %2¬∞",
        "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"field_dropdown","name":"ANG","options":ANG_5}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },
      { "type":"servo_in","message0":"ÏÑúÎ≥¥Î™®ÌÑ∞ %1 Í∞ÅÎèÑ %2¬∞",
        "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"input_value","name":"ANG","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },
      { "type":"servo_slow","message0":"Ïä¨Î°úÏö∞ ÏÑúÎ≥¥ %1 ÏßÄÏó∞ %2 ms Í∞ÅÎèÑ %3¬∞",
        "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"input_value","name":"DELAY","check":"Number"},{"type":"input_value","name":"ANG","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },

      { "type":"melody","message0":"Î©úÎ°úÎîî ÏùåÎÜíÏù¥ %1 ÏÜåÎ¶¨ÏãúÍ∞Ñ %2 ms ÎåÄÍ∏∞ÏãúÍ∞Ñ %3 ms",
        "args0":[{"type":"field_dropdown","name":"PITCH","options":PITCHES},{"type":"input_value","name":"DUR","check":"Number"},{"type":"input_value","name":"WAIT","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":300 },

      { "type":"led_ctrl","message0":"LED %1 Î™®Îìú %2 Í∞í %3",
        "args0":[{"type":"field_dropdown","name":"TGT","options":LED_TGT},{"type":"field_dropdown","name":"MODE","options":LED_MODE},{"type":"field_dropdown","name":"VAL","options":LED_VALS}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":330 },

      { "type":"repeat_forever","message0":"forever %1 %2",
        "args0":[{"type":"input_statement","name":"DO"},{"type":"input_dummy"}],"previousStatement":null,"nextStatement":null,"colour":120 },

      { "type":"wait_seconds","message0":"%1 Ï¥à Í∏∞Îã§Î¶¨Í∏∞",
        "args0":[{"type":"input_value","name":"SEC","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":120 },

      { "type":"control_wait_until","message0":"Îã§ÏùåÍπåÏßÄ Í∏∞Îã§Î¶¨Í∏∞ %1",
        "args0":[{"type":"input_value","name":"COND","check":"Boolean"}],"previousStatement":null,"nextStatement":null,"colour":120 },

      { "type":"control_repeat_until","message0":"Îã§ÏùåÍπåÏßÄ Î∞òÎ≥µ %1 %2 %3",
        "args0":[{"type":"input_value","name":"COND","check":"Boolean"},{"type":"input_statement","name":"DO"},{"type":"input_dummy"}],
        "previousStatement":null,"nextStatement":null,"colour":120 }
    ]);

    /* ‚îÄ‚îÄ Í∞í/Ï°∞Í±¥ ÌëúÌòÑÏãù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function numFromInput(parent, name, def=0){
      const n = Number(Blockly.JavaScript.valueToCode(parent, name, Blockly.JavaScript.ORDER_NONE) ?? '');
      return Number.isFinite(n) ? n : def;
    }
    function exprFromBlock(b){
      if(!b) return '/* cond */';
      switch(b.type){
        case 'math_number': return String(b.getFieldValue('NUM'));
        case 'logic_boolean': return (b.getFieldValue('BOOL')==='TRUE')?'true':'false';
        case 'logic_negate': return '!(' + exprFromBlock(b.getInputTargetBlock('BOOL')) + ')';
        case 'logic_operation': {
          const op = b.getFieldValue('OP')==='AND'?'&&':'||';
          return '('+exprFromBlock(b.getInputTargetBlock('A'))+' '+op+' '+exprFromBlock(b.getInputTargetBlock('B'))+')';
        }
        case 'logic_compare': {
          const map={EQ:'==',NEQ:'!=',LT:'<',LTE:'<=',GT:'>',GTE:'>='};
          const op = map[b.getFieldValue('OP')] || '==';
          return '('+exprFromBlock(b.getInputTargetBlock('A'))+' '+op+' '+exprFromBlock(b.getInputTargetBlock('B'))+')';
        }
        case 'math_arithmetic': {
          const map={ADD:'+',MINUS:'-',MULTIPLY:'*',DIVIDE:'/',POWER:'^'};
          const op = map[b.getFieldValue('OP')]||'+';
          const A = exprFromBlock(b.getInputTargetBlock('A'));
          const B = exprFromBlock(b.getInputTargetBlock('B'));
          return '('+A+' '+op+' '+B+')';
        }
        case 'math_random_int': {
          const A = exprFromBlock(b.getInputTargetBlock('FROM')) || '0';
          const B = exprFromBlock(b.getInputTargetBlock('TO')) || '0';
          return `random(${A}, ${B})`;
        }
        case 'in_touch':  return `TOUCH(${b.getFieldValue('PIN')})`;
        case 'in_xkeypad':return `XKEY(${b.getFieldValue('PIN')}, ${b.getFieldValue('BTN')})`;
        case 'in_ir_dist':{
          const d = numFromInput(b,'DIST',10);
          return `(IR(${b.getFieldValue('PIN')}) <= ${d})`;
        }
      }
      return '/* cond */';
    }

    /* ‚îÄ‚îÄ ÏàúÌöå: ÎÖ∏Îìú/Ï≤¥Ïù∏ Î∂ÑÎ¶¨(Ï§ëÎ≥µ Í∑ºÏ†à) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function walkNode(b, list){
      if(!b) return;
      switch(b.type){
        /* Ï∂úÎ†• */
        case 'motor12_dd':{
          const v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS');
          list.push({type:'CMD',s:`M12 ${v1} ${v2} ${ms}`}); if(ms>0) list.push({type:'W',args:[ms]}); break;
        }
        case 'motor12_in':{
          const v1=numFromInput(b,'M1',0),v2=numFromInput(b,'M2',0),ms=numFromInput(b,'MS',0);
          list.push({type:'CMD',s:`M12 ${Math.round(v1)} ${Math.round(v2)} ${Math.round(ms)}`}); if(ms>0) list.push({type:'W',args:[ms]}); break;
        }
        case 'motor34_dd':{
          const v3=+b.getFieldValue('M3'),v4=+b.getFieldValue('M4'),ms=+b.getFieldValue('MS');
          list.push({type:'CMD',s:`M34 ${v3} ${v4} ${ms}`}); if(ms>0) list.push({type:'W',args:[ms]}); break;
        }
        case 'motor34_in':{
          const v3=numFromInput(b,'M3',0),v4=numFromInput(b,'M4',0),ms=numFromInput(b,'MS',0);
          list.push({type:'CMD',s:`M34 ${Math.round(v3)} ${Math.round(v4)} ${Math.round(ms)}`}); if(ms>0) list.push({type:'W',args:[ms]}); break;
        }
        case 'servo_dd':{
          const out=b.getFieldValue('OUT'),ang=+b.getFieldValue('ANG'); list.push({type:'CMD',s:`SV ${out} ${Math.round(ang)}`}); break;
        }
        case 'servo_in':{
          const out=b.getFieldValue('OUT'),ang=numFromInput(b,'ANG',90); list.push({type:'CMD',s:`SV ${out} ${Math.round(ang)}`}); break;
        }
        case 'servo_slow':{
          const out=b.getFieldValue('OUT'),del=numFromInput(b,'DELAY',5),ang=numFromInput(b,'ANG',90); list.push({type:'CMD',s:`SVS ${out} ${Math.round(del)} ${Math.round(ang)}`}); break;
        }
        case 'melody':{
          const p=b.getFieldValue('PITCH'),dur=numFromInput(b,'DUR',200),wait=numFromInput(b,'WAIT',250);
          list.push({type:'CMD',s:`MEL ${p} ${Math.round(dur)} ${Math.round(wait)}`}); if(wait>0) list.push({type:'W',args:[wait]}); break;
        }
        case 'led_ctrl':{
          const t=b.getFieldValue('TGT'),m=b.getFieldValue('MODE'),v=+b.getFieldValue('VAL'); list.push({type:'CMD',s:`LED ${t} ${m} ${v}`}); break;
        }

        /* Ï†úÏñ¥ */
        case 'repeat_forever':{
          const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
          list.push({type:'LOOP_INF',body:inner}); break;
        }
        case 'controls_repeat_ext':{
          const times = Math.max(0, numFromInput(b,'TIMES',1));
          const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
          list.push({type:'FOR',count:times,body:inner}); break;
        }
        case 'controls_if':{
          const branches=[];
          let i=0; while(b.getInput('IF'+i)){
            const cond = exprFromBlock(b.getInputTargetBlock('IF'+i));
            const inner=[]; const first=b.getInputTargetBlock('DO'+i); walkChain(first, inner);
            branches.push({cond, body:inner}); i++;
          }
          if(b.getInput('ELSE')){
            const inner=[]; const first=b.getInputTargetBlock('ELSE'); walkChain(first, inner);
            branches.push({cond:null, body:inner});
          }
          list.push({type:'IF', branches}); break;
        }
        case 'wait_seconds':{
          const s=numFromInput(b,'SEC',1); if(s>0) list.push({type:'W',args:[s*1000]}); break;
        }
        case 'control_wait_until':{
          const cond = exprFromBlock(b.getInputTargetBlock('COND')); list.push({type:'WAIT_UNTIL',cond}); break;
        }
        case 'control_repeat_until':{
          const cond = exprFromBlock(b.getInputTargetBlock('COND'));
          const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
          list.push({type:'REPEAT_UNTIL',cond,body:inner}); break;
        }
      }
    }
    function walkChain(start, list){
      for(let node=start; node; node=node.getNextBlock()){
        walkNode(node, list);
      }
    }

    /* ÏóîÌä∏Î¶¨ ÏÑ†ÌÉù ‚Üí ÌîÑÎ°úÍ∑∏Îû® ÏÉùÏÑ± + Ï†ïÍ∑úÌôî */
    function firstExecutableTopStack(){
      const tops = ws.getTopBlocks(true);
      for(const b of tops){
        if(!b.outputConnection && (b.nextConnection || b.statementInputCount>0 || b.type==='xrobo_start')) return b;
      }
      return null;
    }
    function normalizeProgram(list){
      const out=[];
      for(const ins of list){
        if(ins.type==='CMD'){
          const prev=out[out.length-1];
          if(prev && prev.type==='CMD' && prev.s===ins.s){ continue; }     // Ïó∞ÏÜç ÎèôÏùº Î™ÖÎ†π Ï†úÍ±∞
        }else if(ins.type==='W'){
          if(!Number.isFinite(ins.args?.[0]) || ins.args[0]<=0) continue;
          const prev=out[out.length-1];
          if(prev && prev.type==='W'){ prev.args[0]+=ins.args[0]; continue; } // Ïó∞ÏÜç delay Î≥ëÌï©
        }
        out.push(ins);
      }
      return out;
    }
    function blocksToProgram(){
      const starts=ws.getBlocksByType('xrobo_start',true);
      let entry=null, startChain=null;
      if(starts.length){ entry=starts[0]; startChain=entry.getNextBlock(); }
      else{ entry=firstExecutableTopStack(); startChain=entry; }
      if(!entry) return [];
      const prog=[]; walkChain(startChain, prog);
      return normalizeProgram(prog);
    }

    /* ÌîÑÎ°úÍ∑∏Îû® ‚Üí C/Arduino ÏΩîÎìú */
    function programToC(prog){
      const out=['void setup() {','  // TODO: ÌïÄ Ï¥àÍ∏∞Ìôî','}','', 'void loop() {'];
      const emit=(list,indent='  ')=>{
        for(const ins of list){
          if(ins.type==='CMD'){ out.push(`${indent}send("${ins.s}");`); }
          else if(ins.type==='W'){ out.push(`${indent}delay(${ins.args[0]});`); }
          else if(ins.type==='FOR'){ out.push(`${indent}for (int i=0; i<${ins.count}; ++i) {`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
          else if(ins.type==='IF'){
            let first=true;
            for(const br of ins.branches){
              if(br.cond!==null){ out.push(`${indent}${first?'if':'else if'} (${br.cond}) {`); first=false; }
              else{ out.push(`${indent}else {`); }
              emit(br.body,indent+'  '); out.push(`${indent}}`);
            }
          }
          else if(ins.type==='LOOP_INF'){ out.push(`${indent}while(true){`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
          else if(ins.type==='WAIT_UNTIL'){ out.push(`${indent}while (!(${ins.cond||'/* cond */'})) { delay(50); }`); }
          else if(ins.type==='REPEAT_UNTIL'){ out.push(`${indent}while (!(${ins.cond||'/* cond */'})) {`); emit(ins.body,indent+'  '); out.push(`${indent}  delay(50);`); out.push(`${indent}}`); }
        }
      };
      emit(prog,'  '); out.push('}'); return out.join('\n');
    }

    /* ÏΩîÎìúÎ∑∞ Í∞±Ïã†(ÎîîÎ∞îÏö¥Ïä§) */
    const codeView=document.getElementById('rightTop');
    let refreshTimer=null;
    function refreshCodeDebounced(){
      clearTimeout(refreshTimer);
      refreshTimer=setTimeout(()=>{
        const prog=blocksToProgram();
        codeView.textContent=programToC(prog);
      },100);
    }
    ws.addChangeListener(refreshCodeDebounced);
    refreshCodeDebounced();

    /* ‚îÄ‚îÄ BLE & Ïã§Ìñâ ÌÜ†Í∏Ä (XROBO ÌïÑÌÑ∞ + Ïû¨Ïó∞Í≤∞ Î≤ÑÍ∑∏ ÏàòÏ†ï) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const SERVICE_UUID=0xFFF0;  // MX01/MX-01 Í≥ÑÏó¥ ÏòàÏãú
    let bleDevice=null,bleServer=null,bleService=null,writeChar=null,notifyChar=null;
    let connectToken=0; // ÎπÑÎèôÍ∏∞ Î≥¥Ìò∏ ÌÜ†ÌÅ∞
    const $=id=>document.getElementById(id), log=m=>{ const L=$('log'); L.textContent+=m+"\n"; L.scrollTop=L.scrollHeight; };
    let isConnected=false, isRunning=false;
    const btnConnect=document.getElementById('connectToggle');
    const btnRun=document.getElementById('runToggle');
    const dot=document.getElementById('statusDot');
    const enc=s=>new TextEncoder().encode(s);

    function resetBleRefs(){ bleDevice=null; bleServer=null; bleService=null; writeChar=null; notifyChar=null; }
    function setConnected(v){
      isConnected=v;
      btnConnect.textContent=v?'Ìï¥Ï†ú':'Ïó∞Í≤∞';
      btnRun.disabled=!v;
      dot.classList.toggle('on',v); dot.classList.toggle('off',!v);
      dot.textContent=v?'on':'off';
      if(!v) setRunning(false);
    }
    function setRunning(v){ isRunning=v; btnRun.textContent=v?'‚ñ† Ï†ïÏßÄ':'‚ñ∂ Ïã§Ìñâ'; btnRun.style.background=v?'#ef4444':'#16a34a'; }
    setConnected(false); setRunning(false);

    async function sendCmd(s){
      if(!writeChar) throw new Error('BLE ÎØ∏Ïó∞Í≤∞');
      await writeChar.writeValue(enc(s+'\n')); log('‚û°Ô∏è '+s);
    }

    function onDisconnected(ev){
      // ÌòÑÏû¨ Ïó∞Í≤∞Îêú Ïû•ÏπòÏù∏ÏßÄ ÌôïÏù∏ (Ïù¥Ï†Ñ Ïû•Ïπò Ïù¥Î≤§Ìä∏Í∞Ä ÏÉà Ïó∞Í≤∞ÏùÑ ÎÅäÏßÄ ÏïäÎèÑÎ°ù)
      if(bleDevice && ev?.target && ev.target !== bleDevice) return;
      log('üîå Ìï¥Ï†úÎê®');
      setConnected(false); resetBleRefs();
    }

    async function connectBLE(){
      if(!navigator.bluetooth){ alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Web Bluetooth ÎØ∏ÏßÄÏõêÏûÖÎãàÎã§.'); return; }
      const myToken=++connectToken;
      try{
        log('‚è≥ BLE Ïä§Ï∫î‚Ä¶ (XROBO*)');
        // Î∏åÎùºÏö∞Ï†Ä ÏÑ†ÌÉù ÌåùÏóÖÏóê 'XROBO*' Ïû•ÏπòÎßå Î≥¥Ïù¥ÎèÑÎ°ù ÌïÑÌÑ∞
        const dev=await navigator.bluetooth.requestDevice({
          filters:[{ namePrefix:'XROBO' }],
          optionalServices:[SERVICE_UUID, 0xFFF3, 0xFFF4] // ÌïÑÏöî Ïãú ÌäπÏÑ± ÌÉêÏÉâÏö©
        });
        if(connectToken!==myToken) return; // Îã§Î•∏ Ïó∞Í≤∞ ÏãúÎèÑ Ïö∞ÏÑ†
        // Ïù¥Ï†Ñ Ï∞∏Ï°∞ Ï¥àÍ∏∞Ìôî
        try{ bleDevice?.removeEventListener('gattserverdisconnected', onDisconnected); }catch(_){}
        resetBleRefs();
        bleDevice=dev;
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

        bleServer=await bleDevice.gatt.connect();
        if(connectToken!==myToken) return;
        bleService=await bleServer.getPrimaryService(SERVICE_UUID);

        // ÌäπÏÑ± ÌÉêÏÉâ (Ïö∞ÏÑ† ÌëúÏ§Ä Ìï∏Îì§, Ïã§Ìå® Ïãú Ï†ÑÏ≤¥ Ï°∞Ìöå)
        try{ writeChar=await bleService.getCharacteristic(0xFFF3);}catch(_){}
        try{ notifyChar=await bleService.getCharacteristic(0xFFF4);}catch(_){}
        if(!writeChar || notifyChar==null){
          const cs=await bleService.getCharacteristics();
          for(const ch of cs){
            const p=ch.properties;
            if(!writeChar && (p.write || p.writeWithoutResponse)) writeChar=ch;
            if(!notifyChar && p.notify) notifyChar=ch;
          }
        }
        if(!writeChar) throw new Error('write ÌäπÏÑ±ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§ (FFF3 Îì±).');

        if(notifyChar){
          await notifyChar.startNotifications();
          notifyChar.addEventListener('characteristicvaluechanged',ev=>{
            const v=new TextDecoder().decode(ev.target.value); log('‚¨ÖÔ∏è '+v);
          });
        }
        if(connectToken!==myToken) return;
        setConnected(true);
        log('‚úÖ Ïó∞Í≤∞: '+(dev.name||'(Ïù¥Î¶Ñ ÏóÜÏùå)'));
      }catch(e){
        console.error(e);
        log('‚ùå Ïó∞Í≤∞ Ïã§Ìå®: '+e);
        setConnected(false); resetBleRefs();
      }
    }

    function disconnectBLE(){
      try{ bleDevice?.gatt?.disconnect(); }catch(_){}
      // Ï¶âÏãú UI Ï†ïÎ¶¨(ÎîîÎ∞îÏù¥Ïä§ Ïù¥Î≤§Ìä∏Î•º Í∏∞Îã§Î¶¨ÏßÄ ÏïäÏùå)
      setConnected(false); resetBleRefs(); ++connectToken;
    }

    btnConnect.onclick=()=>{ isConnected ? disconnectBLE() : connectBLE(); };

    function blocksForRun(){ return blocksToProgram(); }

    btnRun.onclick=async ()=>{
      if(!isRunning){
        if(!writeChar){ alert('Î®ºÏ†Ä BLE Ïó∞Í≤∞!'); return; }
        setRunning(true);
        const prog=blocksForRun();
        if(!prog.length){ alert('Ïã§ÌñâÌï† Î∏îÎ°ùÏù¥ ÏóÜÏäµÎãàÎã§.\n"XROBO start" ÎòêÎäî ÏµúÏÉÅÎã® Ïä§ÌÉùÏùÑ Î∞∞ÏπòÌïòÏÑ∏Ïöî.'); setRunning(false); return; }
        let running=true;
        const runLoop=async(list)=>{
          for(let i=0;i<list.length && running;i++){
            const ins=list[i];
            if(ins.type==='CMD'){ await sendCmd(ins.s); }
            else if(ins.type==='W'){ const [ms]=ins.args; await new Promise(r=>setTimeout(r, Math.max(0,ms))); }
            else if(ins.type==='FOR'){ for(let k=0;k<ins.count && running;k++){ await runLoop(ins.body); } }
            else if(ins.type==='IF'){ /* ÏõπÎü∞ÌÉÄÏûÑÏóêÏÑúÎäî Ï°∞Í±¥ ÎØ∏ÌèâÍ∞Ä (ÏΩîÎìúÎ∑∞ Ï†ÑÏö©) */ }
            else if(ins.type==='WAIT_UNTIL'){ await new Promise(r=>setTimeout(r,50)); i--; }
            else if(ins.type==='REPEAT_UNTIL'){ let guard=0; while(running && guard<200){ await runLoop(ins.body); await new Promise(r=>setTimeout(r,50)); guard++; } }
            else if(ins.type==='LOOP_INF'){ while(running){ await runLoop(ins.body); } }
          }
        };
        try{ await runLoop(prog); }catch(e){ console.error(e); log('‚ö†Ô∏è Ïã§Ìñâ Ïò§Î•ò: '+e); }
        setRunning(false);
      }else{
        setRunning(false);
        try{ if(writeChar) await sendCmd('S'); }catch(_){}
      }
    };

    /* Ï†ÑÏ≤¥ÌôîÎ©¥/Ìå®ÎÑê/Ïä§ÏºÄÏùº */
    const fsBtn=document.getElementById('fsBtn');
    async function enterFS(){ const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); }
    async function exitFS(){ if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }
    fsBtn.onclick=async()=>{ if(document.fullscreenElement) await exitFS(); else await enterFS(); queueResize(); };
    document.addEventListener('fullscreenchange',()=>{ const a=!!document.fullscreenElement; document.body.classList.toggle('fs-active',a);
      fsBtn.textContent=a?'ÎÇòÍ∞ÄÍ∏∞':'üñµ Ï†ÑÏ≤¥ÌôîÎ©¥'; fsBtn.title=a?'Ï†ÑÏ≤¥ÌôîÎ©¥ Ï¢ÖÎ£å':'Ï†ÑÏ≤¥ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò'; queueResize(); });

    const panelToggle=document.getElementById('panelToggle');
    function updatePanelBtn(){ const c=document.body.classList.contains('panel-collapsed'); panelToggle.textContent=c?'‚óÄ Ïã§ÌñâÏ∞Ω Ïó¥Í∏∞':'‚ñ∂ Ïã§ÌñâÏ∞Ω Îã´Í∏∞'; panelToggle.title=c?'Ïã§ÌñâÏ∞Ω Ïó¥Í∏∞':'Ïã§ÌñâÏ∞Ω Îã´Í∏∞'; }
    panelToggle.onclick=()=>{ document.body.classList.toggle('panel-collapsed'); updatePanelBtn(); queueResize(); }; updatePanelBtn();

    const headerEl=document.getElementById('appHeader'), mainEl=document.getElementById('main');
    const HEADER_BASE=headerEl.getBoundingClientRect().height||70; document.documentElement.style.setProperty('--headerBase',HEADER_BASE);
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    function applyUiScale(scale){ const s=clamp(scale,0.6,1.8); document.documentElement.style.setProperty('--uiScale',s);
      headerEl.style.height=(HEADER_BASE*s)+'px'; mainEl.style.height=`calc(100vh - ${Math.round(HEADER_BASE*s)}px)`; }
    function syncUiScale(){ applyUiScale(ws.getScale()); queueResize(); }
    let resizeTimer=null; function queueResize(){ clearTimeout(resizeTimer); resizeTimer=setTimeout(()=>Blockly.svgResize(ws),60); }
    window.addEventListener('resize', queueResize);
    let lastScale=ws.getScale(); ws.addChangeListener(ev=>{ if(ev && ev.type===Blockly.Events.UI && ev.element==='zoom'){ const cur=ws.getScale(); if(cur!==lastScale){ lastScale=cur; syncUiScale(); } } });
    setInterval(()=>{ const cur=ws.getScale(); if(cur!==lastScale){ lastScale=cur; syncUiScale(); } },120);
    syncUiScale();
  </script>
</body>
</html>
