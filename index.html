<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO BLE</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  :root{
    --pad:10px;
    --headerH: 64px;           /* JSë¡œ ì‹¤ì œ ë†’ì´ ê°±ì‹  */
    --btnH: 36px;
    --gap: 8px;
    --headerBgTop: #fff7ed;    /* ì—°í•œ ì£¼í™© ê·¸ë¼ë°ì´ì…˜ */
    --headerBgBottom: #fffbeb;
    --headerBorder: #fed7aa;
  }
  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{ margin:0; font-family:system-ui, sans-serif; background:#fff; }

  /* â”€â”€ í—¤ë”(ì—°í•œ ì£¼í™©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header{
    padding: 8px 12px;
    background: linear-gradient(180deg, var(--headerBgTop), var(--headerBgBottom));
    border-bottom: 1px solid var(--headerBorder);
    position:relative; z-index:10;
  }
  #topbar{
    display:flex; align-items:center; gap: var(--gap);
    flex-wrap: wrap; /* ë§¤ìš° ì¢ì€ í™”ë©´ì—ì„œëŠ” ì•„ë˜ ì¤„ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ */
  }
  .title{
    font-weight: 800; letter-spacing: .2px;
    color:#7c2d12; /* ì§„í•œ ì£¼í™© í…ìŠ¤íŠ¸ */
    margin-right: 12px;
  }
  .spacer{ flex: 1 1 auto; }

  .btn{
    height: var(--btnH);
    padding: 0 12px;
    border:0; border-radius:10px;
    display:inline-flex; align-items:center; justify-content:center;
    font-size:14px; font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    background:#f3f4f6; color:#111827; cursor:pointer;
    user-select:none;
  }
  #connectToggle{ background:#2563eb; color:#fff; }
  #runToggle{ background:#16a34a; color:#fff; }
  #fsBtn{ background:#111827; color:#fff; }

  .state{
    display:inline-flex; align-items:center; gap:6px; height: var(--btnH);
    padding: 0 8px;
  }
  .badgeDot{
    width: 22px; height: 22px; border-radius: 50%;
    display:inline-flex; align-items:center; justify-content:center;
    font-size:11px; font-weight:800; color:#fff;
    box-shadow: 0 0 0 4px rgba(0,0,0,.06) inset;
  }
  .badgeDot.on{ background:#3b82f6; }
  .badgeDot.off{ background:#ef4444; }

  /* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main{
    display:flex; width:100%;
    height: calc(100vh - var(--headerH));
  }
  #left{ position:relative; flex:1 1 auto; min-width:0; height:100%; display:flex; }
  #blocklyDiv{ flex:1 1 auto; min-width:0; height:100%; width:100%; }

  /* ì˜¤ë¥¸ìª½ íŒ¨ë„: ìœ„(ì½”ë“œ), ì•„ë˜(ë¡œê·¸) */
  #right{
    flex:0 0 40%; display:flex; flex-direction:column; background:#fff;
    margin:8px 8px 8px 0; border:1px solid #e5e7eb; border-left:3px solid #60a5fa;
    border-radius:12px 0 0 12px; box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden;
  }
  #rightTop{
    flex:3 1 0; border-bottom:1px solid #e5e7eb;
    background:#f5f7fa; color:#111827;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:13px; line-height:1.45; padding:12px; overflow:auto; white-space:pre; tab-size:2;
  }
  #rightBottom{ flex:1 1 0; padding:10px; background:#0b0f14; color:#d1e4ff; }
  #log{
    height:100%; white-space:pre-wrap; background:#0b0f14; border:1px solid #1f2937; border-radius:8px; padding:10px;
    font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; overflow:auto; color:#d1e4ff;
  }

  /* ì‹¤í–‰ì°½ í† ê¸€ */
  #panelToggle{
    position:absolute; right:10px; top:10px; z-index:9999;
    background:#111827; color:#fff; border-radius:12px; padding:8px 10px;
  }

  /* ê¸°ë³¸ íˆ´ë“¤ í‘œì‹œ */
  .blocklyZoom,.blocklyTrash{ display:block !important; }

  /* ì „ì²´í™”ë©´ ì‹œ ë†’ì´ ê°±ì‹  */
  body.fs-active #main{ height: calc(100vh - var(--headerH)); }

  /* ë§¤ìš° ì‘ì€ í™”ë©´ì—ì„œë„ ë²„íŠ¼ í¬ê¸°ëŠ” ìœ ì§€ */
  @media (max-width: 380px){
    .title{ font-size:14px; }
    .btn{ font-size:13px; }
  }
</style>
</head>
<body>
  <!-- í—¤ë” -->
  <header id="appHeader">
    <div id="topbar">
      <div class="title">XROBO BLE</div>
      <div class="spacer"></div>
      <button id="connectToggle" class="btn">ì—°ê²°</button>
      <span class="state"><span id="statusDot" class="badgeDot off">off</span></span>
      <button id="runToggle" class="btn" disabled>â–¶ ì‹¤í–‰</button>
      <button id="fsBtn" class="btn" title="ì „ì²´í™”ë©´">ğŸ–µ ì „ì²´í™”ë©´</button>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <div id="main">
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelToggle" title="ì‹¤í–‰ì°½ ì—´ê¸°/ë‹«ê¸°">â–¶ ì‹¤í–‰ì°½ ë‹«ê¸°</button>
    </div>
    <div id="right">
      <div id="rightTop"></div>
      <div id="rightBottom">
        <div style="font-size:12px;color:#9ca3af;">ì‹¤í–‰ ë¡œê·¸</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- íˆ´ë°•ìŠ¤ -->
  <xml id="toolbox" style="display:none">
    <category name="ì´ë²¤íŠ¸" colour="#f59e0b"><block type="xrobo_start"></block></category>

    <category name="ì…ë ¥" colour="#06b6d4">
      <block type="in_xkeypad"><field name="PIN">IN1</field><field name="BTN">B1</field></block>
      <block type="in_ir_dist"><field name="PIN">IN1</field><value name="DIST"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="in_touch"><field name="PIN">IN1</field></block>
    </category>

    <category name="ì¶œë ¥" colour="#60a5fa">
      <block type="motor12_dd"><field name="M1">20</field><field name="M2">20</field><field name="MS">500</field></block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="motor34_dd"><field name="M3">20</field><field name="M4">20</field><field name="MS">500</field></block>
      <block type="motor34_in">
        <value name="M3"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M4"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="servo_dd"><field name="OUT">OUT1</field><field name="ANG">90</field></block>
      <block type="servo_in"><field name="OUT">OUT1</field><value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>
      <block type="servo_slow"><field name="OUT">OUT1</field><value name="DELAY"><shadow type="math_number"><field name="NUM">5</field></shadow></value><value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>

      <block type="melody"><field name="PITCH">C4</field><value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value><value name="WAIT"><shadow type="math_number"><field name="NUM">250</field></shadow></value></block>
      <block type="led_ctrl"><field name="TGT">OUT1</field><field name="MODE">BRIGHT</field><field name="VAL">10</field></block>
    </category>

    <category name="ì œì–´" colour="#10b981">
      <block type="repeat_forever"></block>
      <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>
      <block type="controls_if"></block>
      <block type="controls_if"><mutation else="1"></mutation></block>
      <block type="wait_seconds"><value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
      <block type="control_wait_until"></block>
      <block type="control_repeat_until"></block>
    </category>

    <category name="ì—°ì‚°" colour="#a78bfa">
      <block type="math_arithmetic"><value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">2</field></shadow></value></block>
      <block type="logic_compare"><value name="A"><shadow type="math_number"><field name="NUM">10</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">5</field></shadow></value></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="math_random_int"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="math_number"><field name="NUM">20</field></block>
      <block type="math_number"><field name="NUM">500</field></block>
    </category>

    <category name="ë³€ìˆ˜" colour="#f97316" custom="VARIABLE"></category>
    <category name="ë‚´ë¸”ë¡" colour="#ef4444" custom="PROCEDURE"></category>
  </xml>

  <script>
    /* â”€â”€ Zelos í•´íŠ¸ ê°•ì œ ë Œë”ëŸ¬(ëª¨ì ë¸”ë¡ ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    class XroboZelosProvider extends Blockly.zelos.ConstantProvider {
      constructor(){ super(); this.ADD_START_HATS = true; }
    }
    class XroboZelosRenderer extends Blockly.zelos.Renderer {
      constructor(){ super('xrobo_zelos'); }
      makeConstants_(){ return new XroboZelosProvider(); }
    }
    Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);

    const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', {
      base: Blockly.Themes.Zelos, componentStyles: { startHats: true }
    });

    const ws = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      renderer: 'xrobo_zelos', theme: XroboTheme,
      grid: { spacing:20, length:3, colour:'#eee', snap:true },
      zoom: { controls:true, wheel:true }
    });

    /* â”€â”€ ë¸”ë¡ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const PINS_IN=[["IN1","IN1"],["IN2","IN2"],["IN3","IN3"],["IN4","IN4"]];
    const PINS_OUT=[["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
    const KEYS_B=[["B1","B1"],["B2","B2"],["B3","B3"],["B4","B4"],["B5","B5"]];
    const SPEEDS=Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
    const TIMES100=Array.from({length:10},(_,i)=>(100*(i+1))).map(v=>[String(v),String(v)]);
    const ANG_5=Array.from({length:37},(_,i)=>i*5).map(v=>[String(v),String(v)]);
    const LED_TGT=[...PINS_OUT,["CPU","CPU"]];
    const LED_MODE=[["ë°ê¸°","BRIGHT"],["ìˆ¨ì‰¬ê¸°","BREATHE"]];
    const LED_VALS=Array.from({length:20},(_,i)=>[String(i),String(i)]);
    const PITCHES=(()=>{const KR=["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"],EN=["C","D","E","F","G","A","B"],L=[];for(let o=4;o<=6;o++)for(let i=0;i<7;i++)L.push([`${KR[i]}${o}`,`${EN[i]}${o}`]);return L;})();

    Blockly.defineBlocksWithJsonArray([
      { "type":"xrobo_start", "message0":"XROBO start", "nextStatement":null, "colour":36, "hat":"cap" },

      { "type":"in_xkeypad", "message0":"X í‚¤íŒ¨ë“œ í•€ %1 ë²„íŠ¼ %2",
        "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN},{"type":"field_dropdown","name":"BTN","options":KEYS_B}],
        "output":"Boolean","colour":198 },
      { "type":"in_ir_dist", "message0":"ì ì™¸ì„ ì„¼ì„œ í•€ %1 ê±°ë¦¬ %2 ì´ë‚´",
        "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN},{"type":"input_value","name":"DIST","check":"Number"}],
        "output":"Boolean","colour":198 },
      { "type":"in_touch", "message0":"ì ‘ì´‰ì„¼ì„œ í•€ %1 ëˆŒë¦¼",
        "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN}],
        "output":"Boolean","colour":198 },

      { "type":"motor12_dd","message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
        "args0":[{"type":"field_dropdown","name":"M1","options":SPEEDS},{"type":"field_dropdown","name":"M2","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
      { "type":"motor12_in","message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
        "args0":[{"type":"input_value","name":"M1","check":"Number"},{"type":"input_value","name":"M2","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

      { "type":"motor34_dd","message0":"ëª¨í„° M3 %1  M4 %2  ì‹œê°„ %3 ms",
        "args0":[{"type":"field_dropdown","name":"M3","options":SPEEDS},{"type":"field_dropdown","name":"M4","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
      { "type":"motor34_in","message0":"ëª¨í„° M3 %1  M4 %2  ì‹œê°„ %3 ms",
        "args0":[{"type":"input_value","name":"M3","check":"Number"},{"type":"input_value","name":"M4","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

      { "type":"servo_dd","message0":"ì„œë³´ëª¨í„° %1 ê°ë„ %2Â°",
        "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"field_dropdown","name":"ANG","options":ANG_5}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },
      { "type":"servo_in","message0":"ì„œë³´ëª¨í„° %1 ê°ë„ %2Â°",
        "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"input_value","name":"ANG","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },
      { "type":"servo_slow","message0":"ìŠ¬ë¡œìš° ì„œë³´ %1 ì§€ì—° %2 ms ê°ë„ %3Â°",
        "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"input_value","name":"DELAY","check":"Number"},{"type":"input_value","name":"ANG","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },

      { "type":"melody","message0":"ë©œë¡œë”” ìŒë†’ì´ %1 ì†Œë¦¬ì‹œê°„ %2 ms ëŒ€ê¸°ì‹œê°„ %3 ms",
        "args0":[{"type":"field_dropdown","name":"PITCH","options":PITCHES},{"type":"input_value","name":"DUR","check":"Number"},{"type":"input_value","name":"WAIT","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":300 },

      { "type":"led_ctrl","message0":"LED %1 ëª¨ë“œ %2 ê°’ %3",
        "args0":[{"type":"field_dropdown","name":"TGT","options":LED_TGT},{"type":"field_dropdown","name":"MODE","options":LED_MODE},{"type":"field_dropdown","name":"VAL","options":LED_VALS}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":330 },

      { "type":"repeat_forever","message0":"forever %1 %2",
        "args0":[{"type":"input_statement","name":"DO"},{"type":"input_dummy"}],"previousStatement":null,"nextStatement":null,"colour":120 },

      { "type":"wait_seconds","message0":"%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
        "args0":[{"type":"input_value","name":"SEC","check":"Number"}],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":120 },

      { "type":"control_wait_until","message0":"ë‹¤ìŒê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° %1",
        "args0":[{"type":"input_value","name":"COND","check":"Boolean"}],"previousStatement":null,"nextStatement":null,"colour":120 },

      { "type":"control_repeat_until","message0":"ë‹¤ìŒê¹Œì§€ ë°˜ë³µ %1 %2 %3",
        "args0":[{"type":"input_value","name":"COND","check":"Boolean"},{"type":"input_statement","name":"DO"},{"type":"input_dummy"}],
        "previousStatement":null,"nextStatement":null,"colour":120 }
    ]);

    /* â”€â”€ ê°’/ì¡°ê±´ í‘œí˜„ì‹ â†’ ë¬¸ìì—´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function numFromInput(parent, name, def=0){
      const n = Number(Blockly.JavaScript.valueToCode(parent, name, Blockly.JavaScript.ORDER_NONE) ?? '');
      return Number.isFinite(n) ? n : def;
    }
    function exprFromBlock(b){
      if(!b) return '/* cond */';
      switch(b.type){
        case 'math_number': return String(b.getFieldValue('NUM'));
        case 'logic_boolean': return (b.getFieldValue('BOOL')==='TRUE')?'true':'false';
        case 'logic_negate': return '!(' + exprFromBlock(b.getInputTargetBlock('BOOL')) + ')';
        case 'logic_operation': {
          const op = b.getFieldValue('OP')==='AND'?'&&':'||';
          return '('+exprFromBlock(b.getInputTargetBlock('A'))+' '+op+' '+exprFromBlock(b.getInputTargetBlock('B'))+')';
        }
        case 'logic_compare': {
          const map={EQ:'==',NEQ:'!=',LT:'<',LTE:'<=',GT:'>',GTE:'>='};
          const op = map[b.getFieldValue('OP')] || '==';
          return '('+exprFromBlock(b.getInputTargetBlock('A'))+' '+op+' '+exprFromBlock(b.getInputTargetBlock('B'))+')';
        }
        case 'math_arithmetic': {
          const map={ADD:'+',MINUS:'-',MULTIPLY:'*',DIVIDE:'/',POWER:'^'};
          const op = map[b.getFieldValue('OP')]||'+';
          const A = exprFromBlock(b.getInputTargetBlock('A'));
          const B = exprFromBlock(b.getInputTargetBlock('B'));
          return '('+A+' '+op+' '+B+')';
        }
        case 'math_random_int': {
          const A = exprFromBlock(b.getInputTargetBlock('FROM')) || '0';
          const B = exprFromBlock(b.getInputTargetBlock('TO')) || '0';
          return `random(${A}, ${B})`;
        }
        case 'in_touch':  return `TOUCH(${b.getFieldValue('PIN')})`;
        case 'in_xkeypad':return `XKEY(${b.getFieldValue('PIN')}, ${b.getFieldValue('BTN')})`;
        case 'in_ir_dist':{
          const d = numFromInput(b,'DIST',10);
          return `(IR(${b.getFieldValue('PIN')}) <= ${d})`;
        }
      }
      return '/* cond */';
    }

    /* â”€â”€ ìˆœíšŒ: ë…¸ë“œ/ì²´ì¸ ë¶„ë¦¬(ì¤‘ë³µ ê·¼ì ˆ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function walkNode(b, list){
      if(!b) return;
      switch(b.type){
        case 'motor12_dd':{ const v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS');
          list.push({type:'CMD',s:`M12 ${v1} ${v2} ${ms}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
        case 'motor12_in':{ const v1=numFromInput(b,'M1',0),v2=numFromInput(b,'M2',0),ms=numFromInput(b,'MS',0);
          list.push({type:'CMD',s:`M12 ${Math.round(v1)} ${Math.round(v2)} ${Math.round(ms)}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
        case 'motor34_dd':{ const v3=+b.getFieldValue('M3'),v4=+b.getFieldValue('M4'),ms=+b.getFieldValue('MS');
          list.push({type:'CMD',s:`M34 ${v3} ${v4} ${ms}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
        case 'motor34_in':{ const v3=numFromInput(b,'M3',0),v4=numFromInput(b,'M4',0),ms=numFromInput(b,'MS',0);
          list.push({type:'CMD',s:`M34 ${Math.round(v3)} ${Math.round(v4)} ${Math.round(ms)}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
        case 'servo_dd':{ const out=b.getFieldValue('OUT'),ang=+b.getFieldValue('ANG'); list.push({type:'CMD',s:`SV ${out} ${Math.round(ang)}`}); break; }
        case 'servo_in':{ const out=b.getFieldValue('OUT'),ang=numFromInput(b,'ANG',90); list.push({type:'CMD',s:`SV ${out} ${Math.round(ang)}`}); break; }
        case 'servo_slow':{ const out=b.getFieldValue('OUT'),del=numFromInput(b,'DELAY',5),ang=numFromInput(b,'ANG',90); list.push({type:'CMD',s:`SVS ${out} ${Math.round(del)} ${Math.round(ang)}`}); break; }
        case 'melody':{ const p=b.getFieldValue('PITCH'),dur=numFromInput(b,'DUR',200),wait=numFromInput(b,'WAIT',250);
          list.push({type:'CMD',s:`MEL ${p} ${Math.round(dur)} ${Math.round(wait)}`}); if(wait>0) list.push({type:'W',args:[wait]}); break; }
        case 'led_ctrl':{ const t=b.getFieldValue('TGT'),m=b.getFieldValue('MODE'),v=+b.getFieldValue('VAL'); list.push({type:'CMD',s:`LED ${t} ${m} ${v}`}); break; }

        case 'repeat_forever':{
          const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
          list.push({type:'LOOP_INF',body:inner}); break; }
        case 'controls_repeat_ext':{
          const times=Math.max(0, numFromInput(b,'TIMES',1));
          const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
          list.push({type:'FOR',count:times,body:inner}); break; }
        case 'controls_if':{
          const branches=[]; let i=0;
          while(b.getInput('IF'+i)){
            const cond = exprFromBlock(b.getInputTargetBlock('IF'+i));
            const inner=[]; const first=b.getInputTargetBlock('DO'+i); walkChain(first, inner);
            branches.push({cond, body:inner}); i++;
          }
          if(b.getInput('ELSE')){
            const inner=[]; const first=b.getInputTargetBlock('ELSE'); walkChain(first, inner);
            branches.push({cond:null, body:inner});
          }
          list.push({type:'IF',branches}); break;
        }
        case 'wait_seconds':{ const s=numFromInput(b,'SEC',1); if(s>0) list.push({type:'W',args:[s*1000]}); break; }
        case 'control_wait_until':{ const cond=exprFromBlock(b.getInputTargetBlock('COND')); list.push({type:'WAIT_UNTIL',cond}); break; }
        case 'control_repeat_until':{
          const cond=exprFromBlock(b.getInputTargetBlock('COND'));
          const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
          list.push({type:'REPEAT_UNTIL',cond,body:inner}); break; }
      }
    }
    function walkChain(start, list){ for(let n=start; n; n=n.getNextBlock()) walkNode(n, list); }

    function normalizeProgram(list){
      const out=[];
      for(const ins of list){
        if(ins.type==='CMD'){
          const prev=out[out.length-1];
          if(prev && prev.type==='CMD' && prev.s===ins.s) continue; // ë™ì¼ ì—°ì† ì œê±°
        }else if(ins.type==='W'){
          if(!Number.isFinite(ins.args?.[0])||ins.args[0]<=0) continue;
          const prev=out[out.length-1];
          if(prev && prev.type==='W'){ prev.args[0]+=ins.args[0]; continue; } // delay ë³‘í•©
        }
        out.push(ins);
      }
      return out;
    }

    function firstExecutableTopStack(){
      const tops=ws.getTopBlocks(true);
      for(const b of tops){
        if(!b.outputConnection&&(b.nextConnection||b.statementInputCount>0||b.type==='xrobo_start')) return b;
      }
      return null;
    }

    function blocksToProgram(){
      const starts=ws.getBlocksByType('xrobo_start',true);
      let entry=null, startChain=null;
      if(starts.length){ entry=starts[0]; startChain=entry.getNextBlock(); }
      else{ entry=firstExecutableTopStack(); startChain=entry; }
      if(!entry) return [];
      const prog=[]; walkChain(startChain, prog);
      return normalizeProgram(prog);
    }

    function programToC(prog){
      const out=['void setup() {','  // TODO: í•€ ì´ˆê¸°í™”','}','', 'void loop() {'];
      const emit=(list,indent='  ')=>{
        for(const ins of list){
          if(ins.type==='CMD'){ out.push(`${indent}send("${ins.s}");`); }
          else if(ins.type==='W'){ out.push(`${indent}delay(${ins.args[0]});`); }
          else if(ins.type==='FOR'){ out.push(`${indent}for (int i=0; i<${ins.count}; ++i) {`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
          else if(ins.type==='IF'){ let first=true; for(const br of ins.branches){ out.push(`${indent}${br.cond!==null?(first?'if':'else if'):'else'} ${br.cond!==null?`(${br.cond}) `:''}{`); first=false; emit(br.body,indent+'  '); out.push(`${indent}}`);} }
          else if(ins.type==='LOOP_INF'){ out.push(`${indent}while(true){`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
          else if(ins.type==='WAIT_UNTIL'){ out.push(`${indent}while (!(${ins.cond||'/* cond */'})) { delay(50); }`); }
          else if(ins.type==='REPEAT_UNTIL'){ out.push(`${indent}while (!(${ins.cond||'/* cond */'})) {`); emit(ins.body,indent+'  '); out.push(`${indent}  delay(50);`); out.push(`${indent}}`); }
        }
      };
      emit(prog,'  '); out.push('}'); return out.join('\n');
    }

    /* ì½”ë“œë·° ê°±ì‹  */
    const codeView=document.getElementById('rightTop');
    let refreshTimer=null;
    function refreshCodeDebounced(){ clearTimeout(refreshTimer); refreshTimer=setTimeout(()=>{ codeView.textContent=programToC(blocksToProgram()); },100); }
    ws.addChangeListener(refreshCodeDebounced); refreshCodeDebounced();

    /* â”€â”€ í—¤ë” ë†’ì´ ì¸¡ì • â†’ ë©”ì¸ ë†’ì´ ë°˜ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function applyHeaderHeight(){
      const px = document.getElementById('appHeader').offsetHeight || 64;
      document.documentElement.style.setProperty('--headerH', px+'px');
      setTimeout(()=>Blockly.svgResize(ws), 60);
    }
    window.addEventListener('resize', applyHeaderHeight);
    document.addEventListener('fullscreenchange', applyHeaderHeight);
    applyHeaderHeight();

    /* â”€â”€ BLE & ì‹¤í–‰ ì œì–´ (ì·¨ì†Œ ê°€ëŠ¥í•œ ì •ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SERVICE_UUID=0xFFF0;
    let bleDevice=null,bleServer=null,bleService=null,writeChar=null,notifyChar=null;
    let connectToken=0;
    let runToken=0;          // ì‹¤í–‰ ì·¨ì†Œ í† í°
    let isConnected=false, isRunning=false;

    const $=id=>document.getElementById(id);
    const log=m=>{ const L=$('log'); L.textContent+=m+"\n"; L.scrollTop=L.scrollHeight; };
    const btnConnect=$('connectToggle'), btnRun=$('runToggle'), dot=$('statusDot');
    const enc=s=>new TextEncoder().encode(s);

    function resetBleRefs(){ bleDevice=null; bleServer=null; bleService=null; writeChar=null; notifyChar=null; }
    function setConnected(v){
      isConnected=v;
      btnConnect.textContent=v?'í•´ì œ':'ì—°ê²°';
      btnRun.disabled=!v;
      dot.classList.toggle('on',v); dot.classList.toggle('off',!v);
      dot.textContent=v?'on':'off';
      if(!v) setRunning(false);
    }
    function setRunning(v){
      isRunning=v;
      btnRun.textContent=v?'â–  ì •ì§€':'â–¶ ì‹¤í–‰';
      btnRun.style.background = v ? '#ef4444' : '#16a34a';
    }

    async function sendCmdIfActive(s, myRun){
      if(myRun.canceled()) return;
      if(!writeChar) throw new Error('BLE ë¯¸ì—°ê²°');
      await writeChar.writeValue(enc(s+'\n'));
      log('â¡ï¸ '+s);
    }

    async function sleepCancelable(ms, myRun){
      let remain = Math.max(0, ms);
      while(remain > 0){
        if(myRun.canceled()) return;
        const slice = Math.min(50, remain);
        await new Promise(r=>setTimeout(r, slice));
        remain -= slice;
      }
    }

    function onDisconnected(ev){
      if(bleDevice && ev?.target && ev.target !== bleDevice) return;
      log('ğŸ”Œ í•´ì œë¨');
      setConnected(false); resetBleRefs();
    }

    async function connectBLE(){
      if(!navigator.bluetooth){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetooth ë¯¸ì§€ì›ì…ë‹ˆë‹¤.'); return; }
      const myToken=++connectToken;
      try{
        log('â³ BLE ìŠ¤ìº”â€¦');
        const dev = await navigator.bluetooth.requestDevice({
          filters:[{ namePrefix:'XROBO' }],
          optionalServices:[SERVICE_UUID, 0xFFF3, 0xFFF4]
        });
        if(connectToken!==myToken) return;
        try{ bleDevice?.removeEventListener('gattserverdisconnected', onDisconnected); }catch(_){}
        resetBleRefs();
        bleDevice=dev;
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

        bleServer=await bleDevice.gatt.connect();
        if(connectToken!==myToken) return;
        bleService=await bleServer.getPrimaryService(SERVICE_UUID);

        try{ writeChar=await bleService.getCharacteristic(0xFFF3);}catch(_){}
        try{ notifyChar=await bleService.getCharacteristic(0xFFF4);}catch(_){}
        if(!writeChar || notifyChar==null){
          const cs=await bleService.getCharacteristics();
          for(const ch of cs){
            const p=ch.properties;
            if(!writeChar && (p.write||p.writeWithoutResponse)) writeChar=ch;
            if(!notifyChar && p.notify) notifyChar=ch;
          }
        }
        if(!writeChar) throw new Error('write íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        if(notifyChar){
          await notifyChar.startNotifications();
          notifyChar.addEventListener('characteristicvaluechanged',ev=>{
            const v=new TextDecoder().decode(ev.target.value); log('â¬…ï¸ '+v);
          });
        }
        if(connectToken!==myToken) return;
        setConnected(true);
        log('âœ… ì—°ê²°: '+(dev.name||'(ì´ë¦„ ì—†ìŒ)'));
      }catch(e){
        console.error(e); log('âŒ ì—°ê²° ì‹¤íŒ¨: '+e);
        setConnected(false); resetBleRefs();
      }
    }
    function disconnectBLE(){
      try{ bleDevice?.gatt?.disconnect(); }catch(_){}
      setConnected(false); resetBleRefs(); ++connectToken;
    }
    btnConnect.onclick = ()=>{ isConnected ? disconnectBLE() : connectBLE(); };

    function blocksForRun(){ return blocksToProgram(); }

    btnRun.onclick = async ()=>{
      if(!isRunning){
        if(!writeChar){ alert('ë¨¼ì € BLE ì—°ê²°!'); return; }
        setRunning(true);
        const prog = blocksForRun();
        if(!prog.length){ alert('ì‹¤í–‰í•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n"XROBO start" ë˜ëŠ” ìµœìƒë‹¨ ìŠ¤íƒì„ ë°°ì¹˜í•˜ì„¸ìš”.'); setRunning(false); return; }

        const myRunId = ++runToken;
        const myRun = { canceled: ()=> myRunId !== runToken || !isRunning };

        const runLoop = async(list)=>{
          for(let i=0;i<list.length;i++){
            if(myRun.canceled()) return;
            const ins=list[i];
            if(ins.type==='CMD'){
              await sendCmdIfActive(ins.s, myRun);
            }else if(ins.type==='W'){
              await sleepCancelable(ins.args[0], myRun);
            }else if(ins.type==='FOR'){
              for(let k=0; k<ins.count; k++){
                if(myRun.canceled()) return;
                await runLoop(ins.body);
              }
            }else if(ins.type==='IF'){
              /* ì›¹ ëŸ°íƒ€ì„ ì¡°ê±´í‰ê°€ ì—†ìŒ: ì½”ë“œë·° ì „ìš© */
            }else if(ins.type==='WAIT_UNTIL'){
              while(!myRun.canceled()){
                await sleepCancelable(50, myRun);
                if(myRun.canceled()) return;
                // ì‹¤ì œ ì¡°ê±´ í‰ê°€ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì—ì„œ ìƒíƒœë¥¼ ì½ì–´ íŒì •
                // í˜„ì¬ëŠ” ì½”ë“œë·° ì „ìš©ì´ë¯€ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€ ë¡œì§ë§Œ ìœ ì§€
                break;
              }
            }else if(ins.type==='REPEAT_UNTIL'){
              let guard=0;
              while(!myRun.canceled() && guard<200){
                await runLoop(ins.body);
                await sleepCancelable(50, myRun);
                guard++;
              }
            }else if(ins.type==='LOOP_INF'){
              while(!myRun.canceled()){
                await runLoop(ins.body);
              }
            }
          }
        };

        try{
          await runLoop(prog);
        }catch(e){
          console.error(e); log('âš ï¸ ì‹¤í–‰ ì˜¤ë¥˜: '+e);
        }finally{
          if(!myRun.canceled()) setRunning(false);
        }
      }else{
        // â–  ì •ì§€
        setRunning(false);
        runToken++;                 // ëª¨ë“  ì‹¤í–‰ ë£¨í”„ ì¦‰ì‹œ ì·¨ì†Œ
        try{ if(writeChar) await writeChar.writeValue(enc('S\n')); }catch(_){}
      }
    };

    /* íŒ¨ë„ í† ê¸€ & ì „ì²´í™”ë©´ */
    const panelToggle=document.getElementById('panelToggle');
    function updatePanelBtn(){
      const c=document.body.classList.contains('panel-collapsed');
      panelToggle.textContent=c?'â—€ ì‹¤í–‰ì°½ ì—´ê¸°':'â–¶ ì‹¤í–‰ì°½ ë‹«ê¸°';
      panelToggle.title=c?'ì‹¤í–‰ì°½ ì—´ê¸°':'ì‹¤í–‰ì°½ ë‹«ê¸°';
    }
    panelToggle.onclick=()=>{ document.body.classList.toggle('panel-collapsed'); updatePanelBtn(); setTimeout(()=>Blockly.svgResize(ws),60); };
    updatePanelBtn();

    const fsBtn=document.getElementById('fsBtn');
    async function enterFS(){ const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); }
    async function exitFS(){ if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }
    fsBtn.onclick=async()=>{ if(document.fullscreenElement) await exitFS(); else await enterFS(); };
    document.addEventListener('fullscreenchange', ()=>{ document.body.classList.toggle('fs-active', !!document.fullscreenElement); applyHeaderHeight(); });

  </script>
</body>
</html>
