<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO ë¸”ë¡ ì½”ë”© â†’ BLE + ì½”ë“œë·°</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  :root{ --pad:10px; --uiScale:1; --headerBase:70; }
  *{ box-sizing:border-box; } body{ margin:0; font-family:system-ui, sans-serif; }

  /* â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header{ padding:var(--pad); border-bottom:1px solid #eee; background:#fff; position:relative; z-index:10;
          height: calc( var(--headerBase) * var(--uiScale) * 1px ); }
  #headerInner{ display:flex; gap:8px; align-items:center; flex-wrap:wrap;
                transform-origin:top left; transform:scale(var(--uiScale)); }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; } .grow{ flex:1 1 auto; }
  input,button{ font-size:14px; padding:8px 12px; border-radius:10px; }
  input{ border:1px solid #ddd; }
  button{ border:0; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.08); transition:background .15s; }
  #connectToggle{ background:#2563eb; color:#fff; }      /* ì—°ê²°/í•´ì œ í† ê¸€ */
  #runToggle{ background:#16a34a; color:#fff; }          /* ì‹¤í–‰/ì •ì§€ í† ê¸€(ì •ì§€ ì‹œ ë¹¨ê°•) */
  #fsBtn{ background:#111827; color:#fff; }

  /* ìƒíƒœ ì (í…ìŠ¤íŠ¸ ë‚´ì¥) */
  .state { display:inline-flex; align-items:center; gap:8px; font-size:12px; }
  .badgeDot{
    width:22px; height:22px; border-radius:50%;
    display:inline-flex; align-items:center; justify-content:center;
    font-weight:700; color:#fff; user-select:none;
    box-shadow:0 0 0 4px rgba(0,0,0,.06) inset;
  }
  .badgeDot.on  { background:#3b82f6; } /* íŒŒë‘ */
  .badgeDot.off { background:#ef4444; } /* ë¹¨ê°• */

  /* â”€â”€ ë³¸ë¬¸ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main{ display:flex; height: calc(100vh - (var(--headerBase) * var(--uiScale) * 1px)); width:100%; }
  #left{ position:relative; flex:1 1 auto; min-width:0; height:100%; display:flex; }
  #blocklyDiv{ flex:1 1 auto; min-width:0; height:100%; width:100%; }

  /* ì˜¤ë¥¸ìª½ íŒ¨ë„: ìœ„(ì½”ë“œ), ì•„ë˜(ë¡œê·¸) */
  #right{
    flex:0 0 40%; display:flex; flex-direction:column; background:#fff;
    margin:8px 8px 8px 0; border:1px solid #e5e7eb; border-left:3px solid #60a5fa;
    border-radius:12px 0 0 12px; box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden;
  }
  /* ì½”ë“œë·°: ì•„ì£¼ ë°ì€ íšŒìƒ‰ */
  #rightTop{
    flex:3 1 0; border-bottom:1px solid #e5e7eb;
    background:#f5f7fa; color:#111827;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:13px; line-height:1.45; padding:12px; overflow:auto; white-space:pre; tab-size:2;
  }
  /* ë¡œê·¸: ê²€ì€ìƒ‰ */
  #rightBottom{ flex:1 1 0; padding:var(--pad); background:#0b0f14; color:#d1e4ff; }
  #log{
    height:100%; white-space:pre-wrap; background:#0b0f14; border:1px solid #1f2937; border-radius:8px; padding:10px;
    font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; overflow:auto; color:#d1e4ff;
  }
  .small{ font-size:12px; color:#9ca3af; }

  body.fs-active #main{ height: calc(100vh - (var(--headerBase) * var(--uiScale) * 1px)); }
  body.panel-collapsed #right{ display:none; } body.panel-collapsed #left{ flex:1 1 100%; }

  /* ì‹¤í–‰ì°½ í† ê¸€ */
  #panelToggle{
    position:absolute; right:10px; top:10px; z-index:9999;
    background:#111827; color:#fff; border-radius:12px; padding:8px 10px;
    transform-origin:top right; transform:scale(var(--uiScale));
  }

  /* Blockly ê¸°ë³¸ +/âˆ’/ë¦¬ì…‹ & íœ´ì§€í†µ í‘œì‹œ ìœ ì§€ */
  .blocklyZoom,.blocklyTrash{ display:block !important; }
</style>
</head>
<body>
  <!-- í—¤ë” -->
  <header id="appHeader">
    <div id="headerInner">
      <div class="row"><strong>XROBO ë¸”ë¡ â†’ BLE + ì½”ë“œë·°</strong></div>
      <div class="row grow">
        <input id="devName" placeholder="ë‚´ ê¸°ê¸° ì´ë¦„(ì˜ˆ: MX-AB12)" />
        <button id="connectToggle">ì—°ê²°</button>
        <button id="runToggle" disabled>â–¶ ì‹¤í–‰</button>
        <span class="state"><span id="statusDot" class="badgeDot off">off</span></span>
        <button id="fsBtn" title="ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜">ğŸ–µ ì „ì²´í™”ë©´</button>
      </div>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <div id="main">
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelToggle" title="ì‹¤í–‰ì°½ ì—´ê¸°/ë‹«ê¸°">â–¶ ì‹¤í–‰ì°½ ë‹«ê¸°</button>
    </div>

    <div id="right">
      <div id="rightTop"><!-- C/Arduino ì½”ë“œë·° --></div>
      <div id="rightBottom">
        <div class="small">ì‹¤í–‰ ë¡œê·¸</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- íˆ´ë°•ìŠ¤ -->
  <xml id="toolbox" style="display:none">
    <category name="ì´ë²¤íŠ¸" colour="#f59e0b">
      <block type="xrobo_start"></block>
    </category>

    <category name="ì…ë ¥" colour="#06b6d4">
      <block type="in_xkeypad"><field name="PIN">IN1</field><field name="BTN">B1</field></block>
      <block type="in_ir_dist"><field name="PIN">IN1</field>
        <value name="DIST"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="in_touch"><field name="PIN">IN1</field></block>
    </category>

    <category name="ì¶œë ¥" colour="#60a5fa">
      <block type="motor12_dd"><field name="M1">20</field><field name="M2">20</field><field name="MS">500</field></block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="motor34_dd"><field name="M3">20</field><field name="M4">20</field><field name="MS">500</field></block>
      <block type="motor34_in">
        <value name="M3"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M4"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <!-- ì„œë³´: 0~180(5ë„ ê°„ê²©) ë“œë¡­ë‹¤ìš´ + ìˆ«ì ì…ë ¥í˜• -->
      <block type="servo_dd"><field name="OUT">OUT1</field><field name="ANG">90</field></block>
      <block type="servo_in"><field name="OUT">OUT1</field>
        <value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>
      <block type="servo_slow"><field name="OUT">OUT1</field>
        <value name="DELAY"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
        <value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>

      <block type="melody"><field name="PITCH">C4</field>
        <value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value>
        <value name="WAIT"><shadow type="math_number"><field name="NUM">250</field></shadow></value></block>

      <block type="led_ctrl"><field name="TGT">OUT1</field><field name="MODE">BRIGHT</field><field name="VAL">10</field></block>
    </category>

    <category name="ì œì–´" colour="#10b981">
      <block type="repeat_forever"></block>
      <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="controls_if"></block>
      <block type="controls_if"><mutation else="1"></mutation></block>
      <block type="wait_seconds"><value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
      <block type="control_wait_until"></block>
      <block type="control_repeat_until"></block>
    </category>

    <category name="ì—°ì‚°" colour="#a78bfa">
      <block type="math_arithmetic"><value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
        <value name="B"><shadow type="math_number"><field name="NUM">2</field></shadow></value></block>
      <block type="logic_compare"><value name="A"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
        <value name="B"><shadow type="math_number"><field name="NUM">5</field></shadow></value></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="math_random_int"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
        <value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="math_number"><field name="NUM">20</field></block>
      <block type="math_number"><field name="NUM">500</field></block>
    </category>

    <category name="ë³€ìˆ˜" colour="#f97316" custom="VARIABLE"></category>
    <category name="ë‚´ë¸”ë¡" colour="#ef4444" custom="PROCEDURE"></category>
  </xml>

  <script>
    /* 0) Zelos í•´íŠ¸ ê°•ì œ ë Œë”ëŸ¬ */
    class XroboZelosProvider extends Blockly.zelos.ConstantProvider {
      constructor(){ super(); this.ADD_START_HATS = true; }
    }
    class XroboZelosRenderer extends Blockly.zelos.Renderer {
      constructor(){ super('xrobo_zelos'); }
      makeConstants_(){ return new XroboZelosProvider(); }
    }
    Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);

    /* 1) í•´íŠ¸ on í…Œë§ˆ */
    const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', {
      base: Blockly.Themes.Zelos,
      componentStyles: { startHats: true }
    });

    /* 2) Blockly ì£¼ì… */
    const ws = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      renderer: 'xrobo_zelos',   // â˜… ì»¤ìŠ¤í…€ Zelos
      theme: XroboTheme,
      grid: { spacing:20, length:3, colour:'#eee', snap:true },
      zoom: { controls:true, wheel:true }
    });

    /* 3) ë¸”ë¡ ì •ì˜ */
    const PINS_IN  = [["IN1","IN1"],["IN2","IN2"],["IN3","IN3"],["IN4","IN4"]];
    const PINS_OUT = [["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
    const KEYS_B   = [["B1","B1"],["B2","B2"],["B3","B3"],["B4","B4"],["B5","B5"]];
    const SPEEDS   = Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
    const TIMES100 = Array.from({length:10},(_,i)=>(100*(i+1))).map(v=>[String(v),String(v)]);
    const ANG_5    = Array.from({length:37},(_,i)=>i*5).map(v=>[String(v),String(v)]);
    const LED_TGT  = [...PINS_OUT,["CPU","CPU"]];
    const LED_MODE = [["ë°ê¸°","BRIGHT"],["ìˆ¨ì‰¬ê¸°","BREATHE"]];
    const LED_VALS = Array.from({length:20},(_,i)=>[String(i),String(i)]);
    const PITCHES  = (()=>{
      const KR=["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"], EN=["C","D","E","F","G","A","B"], L=[];
      for(let o=4;o<=6;o++) for(let i=0;i<7;i++) L.push([`${KR[i]}${o}`,`${EN[i]}${o}`]); return L;
    })();

    Blockly.defineBlocksWithJsonArray([
      { "type":"xrobo_start", "message0":"XROBO start", "nextStatement":null, "colour":36, "hat":"cap" },

      { "type":"in_xkeypad", "message0":"X í‚¤íŒ¨ë“œ í•€ %1 ë²„íŠ¼ %2",
        "args0":[ {"type":"field_dropdown","name":"PIN","options":PINS_IN}, {"type":"field_dropdown","name":"BTN","options":KEYS_B} ],
        "output":"Boolean","colour":198 },
      { "type":"in_ir_dist", "message0":"ì ì™¸ì„ ì„¼ì„œ í•€ %1 ê±°ë¦¬ %2 ì´ë‚´",
        "args0":[ {"type":"field_dropdown","name":"PIN","options":PINS_IN}, {"type":"input_value","name":"DIST","check":"Number"} ],
        "output":"Boolean","colour":198 },
      { "type":"in_touch", "message0":"ì ‘ì´‰ì„¼ì„œ í•€ %1 ëˆŒë¦¼",
        "args0":[ {"type":"field_dropdown","name":"PIN","options":PINS_IN} ],
        "output":"Boolean","colour":198 },

      { "type":"motor12_dd", "message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
        "args0":[ {"type":"field_dropdown","name":"M1","options":SPEEDS}, {"type":"field_dropdown","name":"M2","options":SPEEDS}, {"type":"field_dropdown","name":"MS","options":TIMES100} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
      { "type":"motor12_in", "message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
        "args0":[ {"type":"input_value","name":"M1","check":"Number"}, {"type":"input_value","name":"M2","check":"Number"}, {"type":"input_value","name":"MS","check":"Number"} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

      { "type":"motor34_dd", "message0":"ëª¨í„° M3 %1  M4 %2  ì‹œê°„ %3 ms",
        "args0":[ {"type":"field_dropdown","name":"M3","options":SPEEDS}, {"type":"field_dropdown","name":"M4","options":SPEEDS}, {"type":"field_dropdown","name":"MS","options":TIMES100} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
      { "type":"motor34_in", "message0":"ëª¨í„° M3 %1  M4 %2  ì‹œê°„ %3 ms",
        "args0":[ {"type":"input_value","name":"M3","check":"Number"}, {"type":"input_value","name":"M4","check":"Number"}, {"type":"input_value","name":"MS","check":"Number"} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

      { "type":"servo_dd", "message0":"ì„œë³´ëª¨í„° %1 ê°ë„ %2Â°",
        "args0":[ {"type":"field_dropdown","name":"OUT","options":PINS_OUT}, {"type":"field_dropdown","name":"ANG","options":ANG_5} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },
      { "type":"servo_in", "message0":"ì„œë³´ëª¨í„° %1 ê°ë„ %2Â°",
        "args0":[ {"type":"field_dropdown","name":"OUT","options":PINS_OUT}, {"type":"input_value","name":"ANG","check":"Number"} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },
      { "type":"servo_slow", "message0":"ìŠ¬ë¡œìš° ì„œë³´ %1 ì§€ì—° %2 ms ê°ë„ %3Â°",
        "args0":[ {"type":"field_dropdown","name":"OUT","options":PINS_OUT}, {"type":"input_value","name":"DELAY","check":"Number"}, {"type":"input_value","name":"ANG","check":"Number"} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },

      { "type":"melody", "message0":"ë©œë¡œë”” ìŒë†’ì´ %1 ì†Œë¦¬ì‹œê°„ %2 ms ëŒ€ê¸°ì‹œê°„ %3 ms",
        "args0":[ {"type":"field_dropdown","name":"PITCH","options":PITCHES}, {"type":"input_value","name":"DUR","check":"Number"}, {"type":"input_value","name":"WAIT","check":"Number"} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":300 },

      { "type":"led_ctrl", "message0":"LED %1 ëª¨ë“œ %2 ê°’ %3",
        "args0":[ {"type":"field_dropdown","name":"TGT","options":LED_TGT}, {"type":"field_dropdown","name":"MODE","options":LED_MODE}, {"type":"field_dropdown","name":"VAL","options":LED_VALS} ],
        "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":330 },

      { "type":"repeat_forever", "message0":"forever %1 %2",
        "args0":[ {"type":"input_statement","name":"DO"}, {"type":"input_dummy"} ],
        "previousStatement":null, "nextStatement":null, "colour":120 },

      { "type":"wait_seconds", "message0":"%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
        "args0":[ {"type":"input_value","name":"SEC","check":"Number"} ],
        "previousStatement":null, "nextStatement":null, "inputsInline":true, "colour":120 },

      { "type":"control_wait_until", "message0":"ë‹¤ìŒê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° %1",
        "args0":[ {"type":"input_value","name":"COND","check":"Boolean"} ],
        "previousStatement":null,"nextStatement":null,"colour":120 },

      { "type":"control_repeat_until", "message0":"ë‹¤ìŒê¹Œì§€ ë°˜ë³µ %1 %2 %3",
        "args0":[ {"type":"input_value","name":"COND","check":"Boolean"}, {"type":"input_statement","name":"DO"}, {"type":"input_dummy"} ],
        "previousStatement":null,"nextStatement":null,"colour":120 }
    ]);

    /* 4) ë¸”ë¡ â†’ ì‹¤í–‰ ì‹œí€€ìŠ¤ (XROBO start ì—†ì„ ë•Œë„ ì‘ë™) */
    const num = (b,n,d=0)=>Number(Blockly.JavaScript.valueToCode(b,n,Blockly.JavaScript.ORDER_NONE) ?? d);
    function firstExecutableTopStack(){
      const tops = ws.getTopBlocks(true);
      for(const b of tops){
        // ê°’(ë‘¥ê·¼) ë¸”ë¡ì´ ì•„ë‹Œ 'ë¬¸ì¥í˜•' ë¸”ë¡ ì²´ì¸ì„ ì„ íƒ
        if (!b.outputConnection && (b.nextConnection || b.statementInputCount > 0 || b.type === 'xrobo_start')){
          return b;
        }
      }
      return null;
    }
    function blocksToProgram(){
      const starts=ws.getBlocksByType('xrobo_start',true);
      let entry = null, next = null;
      if(starts.length){ entry = starts[0]; next = entry.getNextBlock(); }
      else { entry = firstExecutableTopStack(); next = entry; }
      if(!entry) return []; // ì•„ë¬´ ë¬¸ì¥í˜• ìŠ¤íƒì´ ì—†ìœ¼ë©´ ë¹ˆ í”„ë¡œê·¸ë¨

      const prog=[];
      (function walk(b,list){
        if(!b) return;
        switch(b.type){
          case 'motor12_dd':{ const v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS'); list.push({type:'CMD',s:`M12 ${v1} ${v2} ${ms}`}); list.push({type:'W',args:[ms]}); break; }
          case 'motor12_in':{ const v1=num(b,'M1',0),v2=num(b,'M2',0),ms=num(b,'MS',0); list.push({type:'CMD',s:`M12 ${Math.round(v1)} ${Math.round(v2)} ${Math.round(ms)}`}); list.push({type:'W',args:[ms]}); break; }
          case 'motor34_dd':{ const v3=+b.getFieldValue('M3'),v4=+b.getFieldValue('M4'),ms=+b.getFieldValue('MS'); list.push({type:'CMD',s:`M34 ${v3} ${v4} ${ms}`}); list.push({type:'W',args:[ms]}); break; }
          case 'motor34_in':{ const v3=num(b,'M3',0),v4=num(b,'M4',0),ms=num(b,'MS',0); list.push({type:'CMD',s:`M34 ${Math.round(v3)} ${Math.round(v4)} ${Math.round(ms)}`}); list.push({type:'W',args:[ms]}); break; }
          case 'servo_dd'  :{ const out=b.getFieldValue('OUT'),ang=+b.getFieldValue('ANG'); list.push({type:'CMD',s:`SV ${out} ${Math.round(ang)}`}); break; }
          case 'servo_in'  :{ const out=b.getFieldValue('OUT'),ang=num(b,'ANG',90); list.push({type:'CMD',s:`SV ${out} ${Math.round(ang)}`}); break; }
          case 'servo_slow':{ const out=b.getFieldValue('OUT'),del=num(b,'DELAY',5),ang=num(b,'ANG',90); list.push({type:'CMD',s:`SVS ${out} ${Math.round(del)} ${Math.round(ang)}`}); break; }
          case 'melody'    :{ const p=b.getFieldValue('PITCH'),dur=num(b,'DUR',200),wait=num(b,'WAIT',250); list.push({type:'CMD',s:`MEL ${p} ${Math.round(dur)} ${Math.round(wait)}`}); list.push({type:'W',args:[wait]}); break; }
          case 'led_ctrl'  :{ const t=b.getFieldValue('TGT'),m=b.getFieldValue('MODE'),v=+b.getFieldValue('VAL'); list.push({type:'CMD',s:`LED ${t} ${m} ${v}`}); break; }
          case 'repeat_forever':{
            const inner=[]; let c=b.getInputTargetBlock('DO');
            while(c){ walk(c,inner); c=c.getNextBlock(); }
            list.push({type:'LOOP_INF',body:inner}); break; }
          case 'wait_seconds':{ const s=num(b,'SEC',1); list.push({type:'W',args:[s*1000]}); break; }
          case 'control_wait_until':{ list.push({type:'WAIT_UNTIL'}); break; }
          case 'control_repeat_until':{
            const inner=[]; let c=b.getInputTargetBlock('DO'); while(c){ walk(c,inner); c=c.getNextBlock(); }
            list.push({type:'REPEAT_UNTIL',body:inner}); break; }
        }
        walk(b.getNextBlock(),list);
      })(next,prog);
      return prog;
    }

    /* 5) ì½”ë“œë·°: CMDëŠ” sendë§Œ, Wì—ì„œë§Œ delay (ë””ë°”ìš´ìŠ¤ ê°±ì‹ ) */
    function programToC(prog){
      const out=[];
      out.push('void setup() {');
      out.push('  // TODO: í•€ ì´ˆê¸°í™”');
      out.push('}');
      out.push('');
      out.push('void loop() {');
      const emit=(list,indent='  ')=>{
        for(const ins of list){
          if(ins.type==='CMD'){ out.push(`${indent}send("${ins.s}");`); }
          else if(ins.type==='W'){ out.push(`${indent}delay(${ins.args[0]});`); }
          else if(ins.type==='LOOP_INF'){ out.push(`${indent}while(true){`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
          else if(ins.type==='WAIT_UNTIL'){ out.push(`${indent}// wait until (ì¡°ê±´ êµ¬í˜„ í•„ìš”)`); out.push(`${indent}delay(50);`); }
          else if(ins.type==='REPEAT_UNTIL'){ out.push(`${indent}// repeat until (ê°„ë‹¨ í´ë§ ì˜ˆì œ)`); out.push(`${indent}for(int guard=0; guard<200; ++guard){`); emit(ins.body,indent+'  '); out.push(`${indent}  delay(50);`); out.push(`${indent}}`); }
        }
      };
      emit(prog,'  ');
      out.push('}');
      return out.join('\n');
    }
    const codeView=document.getElementById('rightTop');
    let refreshTimer=null;
    function refreshCodeDebounced(){
      clearTimeout(refreshTimer);
      refreshTimer=setTimeout(()=>{
        const prog=blocksToProgram();
        codeView.textContent = programToC(prog);
      },100);
    }
    ws.addChangeListener(refreshCodeDebounced);
    refreshCodeDebounced();

    /* 6) BLE & ì‹¤í–‰ í† ê¸€ (ì—°ê²°/í•´ì œ, ì‹¤í–‰/ì •ì§€) */
    const SERVICE_UUID=0xFFF0;
    let bleDevice=null,bleServer=null,bleService=null,writeChar=null,notifyChar=null;
    const $=id=>document.getElementById(id), log=m=>{ const L=$('log'); L.textContent+=m+"\n"; L.scrollTop=L.scrollHeight; };
    let isConnected=false, isRunning=false;
    const btnConnect=document.getElementById('connectToggle');
    const btnRun=document.getElementById('runToggle');
    const dot=document.getElementById('statusDot');
    const enc=s=>new TextEncoder().encode(s);

    function setConnected(v){ isConnected=v; btnConnect.textContent=v?'í•´ì œ':'ì—°ê²°'; btnRun.disabled=!v; dot.classList.toggle('on',v); dot.classList.toggle('off',!v); dot.textContent=v?'on':'off'; if(!v) setRunning(false); }
    function setRunning(v){ isRunning=v; btnRun.textContent=v?'â–  ì •ì§€':'â–¶ ì‹¤í–‰'; btnRun.style.background=v?'#ef4444':'#16a34a'; }
    setConnected(false); setRunning(false);

    async function sendCmd(s){ if(!writeChar) throw new Error('BLE ë¯¸ì—°ê²°'); await writeChar.writeValue(enc(s+'\n')); log('â¡ï¸ '+s); }

    async function connectBLE(){
      if(!navigator.bluetooth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetooth ë¯¸ì§€ì›ì…ë‹ˆë‹¤.');
      const want=$('devName').value.trim();
      try{
        log('â³ BLE ìŠ¤ìº”â€¦');
        const dev=await navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices:[SERVICE_UUID]});
        if(want && dev.name!==want){ log(`ì„ íƒ: ${dev.name||'(ì—†ìŒ)'} â†’ ì…ë ¥ê³¼ ë¶ˆì¼ì¹˜`); alert('íŒì—…ì—ì„œ ë³¸ì¸ ê¸°ê¸°ë¥¼ ì„ íƒ!'); return; }
        bleDevice=dev; bleDevice.addEventListener('gattserverdisconnected',()=>{ setConnected(false); log('ğŸ”Œ í•´ì œë¨'); });
        bleServer=await bleDevice.gatt.connect(); bleService=await bleServer.getPrimaryService(SERVICE_UUID);
        try{ writeChar=await bleService.getCharacteristic(0xFFF3);}catch(_){}
        try{ notifyChar=await bleService.getCharacteristic(0xFFF4);}catch(_){}
        if(!writeChar||notifyChar==null){
          const cs=await bleService.getCharacteristics();
          for(const ch of cs){ const p=ch.properties; if(!writeChar&&(p.write||p.writeWithoutResponse)) writeChar=ch; if(!notifyChar&&p.notify) notifyChar=ch; }
        }
        if(!writeChar) throw new Error('write íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        if(notifyChar){ await notifyChar.startNotifications(); notifyChar.addEventListener('characteristicvaluechanged',ev=>{ const v=new TextDecoder().decode(ev.target.value); log('â¬…ï¸ '+v);});}
        setConnected(true); log('âœ… ì—°ê²°: '+(dev.name||'(ì´ë¦„ ì—†ìŒ)'));
      }catch(e){ console.error(e); log('âŒ ì—°ê²° ì‹¤íŒ¨: '+e); setConnected(false); }
    }
    function disconnectBLE(){ try{ bleDevice?.gatt?.disconnect(); }catch(_){ } setConnected(false); }
    btnConnect.onclick=()=>{ isConnected?disconnectBLE():connectBLE(); };

    function blocksForRun(){ return blocksToProgram(); }

    btnRun.onclick=async ()=>{
      if(!isRunning){
        if(!writeChar){ alert('ë¨¼ì € BLE ì—°ê²°!'); return; }
        setRunning(true);
        const prog=blocksForRun(); if(!prog.length){ alert('ì‹¤í–‰í•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n"XROBO start" ë˜ëŠ” ìµœìƒë‹¨ ìŠ¤íƒì„ ë°°ì¹˜í•˜ì„¸ìš”.'); setRunning(false); return; }
        let running=true;
        const runLoop=async(list)=>{
          for(let i=0;i<list.length && running;i++){
            const ins=list[i];
            if(ins.type==='CMD'){ await sendCmd(ins.s); }
            else if(ins.type==='W'){ const [ms]=ins.args; await new Promise(r=>setTimeout(r, Math.max(0,ms))); }
            else if(ins.type==='WAIT_UNTIL'){ await new Promise(r=>setTimeout(r,50)); i--; }
            else if(ins.type==='REPEAT_UNTIL'){ let guard=0; while(running && guard<200){ await runLoop(ins.body); await new Promise(r=>setTimeout(r,50)); guard++; } }
            else if(ins.type==='LOOP_INF'){ while(running){ await runLoop(ins.body); } }
          }
        };
        try{ await runLoop(prog); }catch(e){ console.error(e); log('âš ï¸ ì‹¤í–‰ ì˜¤ë¥˜: '+e); }
        setRunning(false);
      }else{
        setRunning(false);
        try{ if(writeChar) await sendCmd('S'); }catch(_){}
      }
    };

    /* ì „ì²´í™”ë©´/íŒ¨ë„/ìŠ¤ì¼€ì¼ */
    const fsBtn=document.getElementById('fsBtn');
    async function enterFS(){ const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); }
    async function exitFS(){ if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }
    fsBtn.onclick=async()=>{ if(document.fullscreenElement) await exitFS(); else await enterFS(); queueResize(); };
    document.addEventListener('fullscreenchange',()=>{ const a=!!document.fullscreenElement; document.body.classList.toggle('fs-active',a);
      fsBtn.textContent=a?'ë‚˜ê°€ê¸°':'ğŸ–µ ì „ì²´í™”ë©´'; fsBtn.title=a?'ì „ì²´í™”ë©´ ì¢…ë£Œ':'ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜'; queueResize(); });

    const panelToggle=document.getElementById('panelToggle');
    function updatePanelBtn(){ const c=document.body.classList.contains('panel-collapsed'); panelToggle.textContent=c?'â—€ ì‹¤í–‰ì°½ ì—´ê¸°':'â–¶ ì‹¤í–‰ì°½ ë‹«ê¸°'; panelToggle.title=c?'ì‹¤í–‰ì°½ ì—´ê¸°':'ì‹¤í–‰ì°½ ë‹«ê¸°'; }
    panelToggle.onclick=()=>{ document.body.classList.toggle('panel-collapsed'); updatePanelBtn(); queueResize(); }; updatePanelBtn();

    const headerEl=document.getElementById('appHeader'), mainEl=document.getElementById('main');
    const HEADER_BASE=headerEl.getBoundingClientRect().height||70; document.documentElement.style.setProperty('--headerBase',HEADER_BASE);
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    function applyUiScale(scale){ const s=clamp(scale,0.6,1.8); document.documentElement.style.setProperty('--uiScale',s);
      headerEl.style.height=(HEADER_BASE*s)+'px'; mainEl.style.height=`calc(100vh - ${Math.round(HEADER_BASE*s)}px)`; }
    function syncUiScale(){ applyUiScale(ws.getScale()); queueResize(); }
    let resizeTimer=null; function queueResize(){ clearTimeout(resizeTimer); resizeTimer=setTimeout(()=>Blockly.svgResize(ws),60); }
    window.addEventListener('resize', queueResize);
    let lastScale=ws.getScale(); ws.addChangeListener(ev=>{ if(ev && ev.type===Blockly.Events.UI && ev.element==='zoom'){ const cur=ws.getScale(); if(cur!==lastScale){ lastScale=cur; syncUiScale(); } } });
    setInterval(()=>{ const cur=ws.getScale(); if(cur!==lastScale){ lastScale=cur; syncUiScale(); } },120);
    syncUiScale();
  </script>
</body>
</html>
