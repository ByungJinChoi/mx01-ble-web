<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>XROBO ë¸”ë¡ ì½”ë”© â†’ BLE ì‹¤ì‹œê°„ ì œì–´</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Blockly -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    :root{ --pad:10px; --uiScale:1; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui, sans-serif; }
    header{
      padding:var(--pad); border-bottom:1px solid #eee; background:#fff;
      position:relative; z-index:10;
      /* í—¤ë” ìì²´ì˜ ë ˆì´ì•„ì›ƒ í¬ê¸°ëŠ” ìœ ì§€ */
      height:auto;
    }
    /* í—¤ë” ì•ˆìª½ ì»¨í…ì¸ ë§Œ ìŠ¤ì¼€ì¼ */
    #headerInner{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      transform-origin: top left;
      transform: scale(var(--uiScale));
    }
    .group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grow{ flex:1 1 auto; }
    input,button{ font-size:14px; padding:8px 12px; border-radius:10px; }
    input{ border:1px solid #ddd; }
    button{ border:0; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    #connect{ background:#2563eb; color:#fff; }
    #disconnect{ background:#64748b; color:#fff; }
    #run{ background:#16a34a; color:#fff; }
    #stop{ background:#ef4444; color:#fff; }
    #fsBtn{ background:#111827; color:#fff; }
    .status{ font-size:12px; background:#eee; border-radius:999px; padding:4px 10px; }
    .ok{ background:#d1fae5; }

    #main{
      display:flex;
      height:calc(100vh - 70px);
      width:100%;
    }

    /* ì™¼ìª½(ì½”ë”©) ë˜í¼: ìƒëŒ€ë°°ì¹˜ë¡œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ì„ ë‚´ë¶€ ìš°ìƒë‹¨ ê³ ì • */
    #left{
      position:relative;
      flex:1 1 60%;
      min-width:0;
      height:100%;
      display:flex;
    }
    #blocklyDiv{
      flex:1 1 auto;
      min-width:0;
      height:100%;
      width:100%;
    }

    /* ì‹¤í–‰ì°½(ì˜¤ë¥¸ìª½) */
    #right{
      flex:1 1 40%;
      border-left:1px solid #eee;
      padding:var(--pad);
      display:flex; flex-direction:column; gap:10px; background:#fff;
      /* ë‚´ìš© ë˜í¼ë§Œ ìŠ¤ì¼€ì¼ */
    }
    #rightInner{
      transform-origin: top right;
      transform: scale(var(--uiScale));
    }
    #log{
      white-space:pre-wrap; background:#f7f7f7; border-radius:10px; padding:10px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; overflow:auto; height:40vh;
    }
    .small{ font-size:12px; color:#666; }

    /* ì „ì²´í™”ë©´ì—ì„œë„ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
    body.fs-active #main{ height:calc(100vh - 70px); }

    /* ì‹¤í–‰ì°½ ë‹«í˜ ëª¨ë“œ: ì˜¤ë¥¸ìª½ íŒ¨ë„ ìˆ¨ê¸°ê³  blocklyDivë¥¼ 100%ë¡œ */
    body.panel-collapsed #right{ display:none; }
    body.panel-collapsed #left{ flex:1 1 100%; }

    /* ì‹¤í–‰ì°½ í† ê¸€ ë²„íŠ¼: ì½”ë”©ì°½(#left) ë‚´ë¶€ ìš°ìƒë‹¨ ê³ ì • + ìŠ¤ì¼€ì¼ */
    #panelToggle{
      position:absolute; right:10px; top:10px;
      z-index: 9999; background:#111827; color:#fff; opacity:0.95;
      border-radius: 12px; padding:8px 10px;
      transform-origin: top right;
      transform: scale(var(--uiScale));
    }
  </style>
</head>
<body>
  <header>
    <div id="headerInner">
      <!-- ì¢Œì¸¡: ì œëª© -->
      <div class="group"><strong>XROBO ë¸”ë¡ â†’ BLE ì œì–´</strong></div>

      <!-- ê°€ìš´ë°: ê¸°ê¸° ì„ íƒ/ì—°ê²° + ì‹¤í–‰/ì •ì§€ + ìƒíƒœ/ì „ì²´í™”ë©´ (ì •ì§€ ì˜† ë°°ì¹˜) -->
      <div class="group grow">
        <input id="devName" placeholder="ë‚´ ê¸°ê¸° ì´ë¦„(ì˜ˆ: MX-AB12)" />
        <button id="connect">ğŸ”— ì—°ê²°</button>
        <button id="disconnect" disabled>âŒ í•´ì œ</button>
        <button id="run" disabled>â–¶ ì‹¤í–‰</button>
        <button id="stop" disabled>â–  ì •ì§€</button>
        <span id="status" class="status">ë¯¸ì—°ê²°</span>
        <button id="fsBtn" title="ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜">ğŸ–µ ì „ì²´í™”ë©´</button>
      </div>
    </div>
  </header>

  <div id="main">
    <!-- ì™¼ìª½: ì½”ë”© ì˜ì—­(í† ê¸€ ë²„íŠ¼ì€ ë‚´ë¶€ ìš°ìƒë‹¨ì— ê³ ì •) -->
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelToggle" title="ì‹¤í–‰ì°½ ì—´ê¸°/ë‹«ê¸°">â–¶ ì‹¤í–‰ì°½ ë‹«ê¸°</button>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì‹¤í–‰ì°½ (ë‚´ìš© ìŠ¤ì¼€ì¼ìš© ë˜í¼ rightInner) -->
    <div id="right">
      <div id="rightInner">
        <div class="small">
          â€¢ HTTPS ë˜ëŠ” localhostì—ì„œ Web Bluetooth ë™ì‘<br>
          â€¢ MX-01 ê¸°ë³¸ ì„œë¹„ìŠ¤: <code>0xFFF0</code> (Write/Notify ìë™ íƒì§€)<br>
          â€¢ ì†¡ì‹  í¬ë§·: <code>M a b</code>, <code>S</code> (ëŒ€ê¸°ëŠ” JSì—ì„œ ì²˜ë¦¬)
        </div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- ìŠ¤í¬ë˜ì¹˜í’ ì¹´í…Œê³ ë¦¬ -->
  <xml id="toolbox" style="display:none">
    <category name="ì´ë²¤íŠ¸" colour="#f59e0b">
      <block type="xrobo_start"></block>
    </category>

    <category name="ì…ë ¥" colour="#06b6d4">
      <block type="math_number"><field name="NUM">20</field></block>
      <block type="math_number"><field name="NUM">0</field></block>
      <block type="math_number"><field name="NUM">1000</field></block>
    </category>

    <category name="ì¶œë ¥" colour="#60a5fa">
      <block type="motor_wait">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="DELAY"><shadow type="math_number"><field name="NUM">1000</field></shadow></value>
      </block>
      <block type="stop_motors"></block>
    </category>

    <category name="ì œì–´" colour="#10b981">
      <block type="controls_if"></block>
      <block type="controls_repeat_ext">
        <value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
      </block>
      <block type="repeat_forever"></block>
      <block type="wait_seconds">
        <value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
    </category>

    <category name="ì—°ì‚°" colour="#a78bfa">
      <block type="math_arithmetic"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="logic_compare"></block>
      <block type="logic_boolean"></block>
    </category>

    <category name="ë³€ìˆ˜" colour="#f97316" custom="VARIABLE"></category>
    <category name="ë‚´ë¸”ë¡" colour="#ef4444" custom="PROCEDURE"></category>
  </xml>

  <script>
    /* ===== 1) Blockly (Scratchí’ zelos) ===== */
    const ws = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      renderer: 'zelos',
      grid: { spacing: 20, length: 3, colour: '#eee', snap: true },
      zoom: { controls: true, wheel: true }
    });

    Blockly.defineBlocksWithJsonArray([
      { "type":"xrobo_start", "message0":"XROBO start", "nextStatement":null, "colour":36, "hat":"cap", "tooltip":"í”„ë¡œê·¸ë¨ ì‹œì‘ ë¸”ë¡ì…ë‹ˆë‹¤." },
      {
        "type":"motor_wait",
        "message0":"motor  M1: %1   M2: %2   delay: %3 ms",
        "args0":[
          {"type":"input_value","name":"M1","check":"Number"},
          {"type":"input_value","name":"M2","check":"Number"},
          {"type":"input_value","name":"DELAY","check":"Number"}
        ],
        "inputsInline":true, "previousStatement":null, "nextStatement":null, "colour":210,
        "tooltip":"ëª¨í„°1/2 ì†ë„ ì„¤ì • í›„ ì§€ì • ì‹œê°„(ms) ëŒ€ê¸°"
      },
      { "type":"stop_motors", "message0":"stop motors", "previousStatement":null, "nextStatement":null, "colour":210, "tooltip":"ëª¨ë“  ëª¨í„° ì •ì§€(S)" },
      {
        "type":"repeat_forever",
        "message0":"forever %1 %2",
        "args0":[ {"type":"input_statement","name":"DO"}, {"type":"input_dummy"} ],
        "previousStatement":null, "nextStatement":null, "colour":120, "tooltip":"ì •ì§€ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œê¹Œì§€ ë°˜ë³µ"
      },
      {
        "type":"wait_seconds",
        "message0":"%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
        "args0":[ {"type":"input_value","name":"SEC","check":"Number"} ],
        "previousStatement":null, "nextStatement":null, "colour":120, "tooltip":"ì§€ì •í•œ ì‹œê°„(ì´ˆ) ê¸°ë‹¤ë¦½ë‹ˆë‹¤."
      }
    ]);

    function blocksToProgram() {
      const starts = ws.getBlocksByType('xrobo_start', true);
      if (!starts.length) return [];
      const prog = [];
      function collect(b, list){
        if (!b) return;
        switch (b.type) {
          case 'motor_wait': {
            const m1 = Number(Blockly.JavaScript.valueToCode(b,'M1',Blockly.JavaScript.ORDER_NONE) || 0);
            const m2 = Number(Blockly.JavaScript.valueToCode(b,'M2',Blockly.JavaScript.ORDER_NONE) || 0);
            const ms = Number(Blockly.JavaScript.valueToCode(b,'DELAY',Blockly.JavaScript.ORDER_NONE) || 0);
            list.push({type:'M', args:[m1, m2]});
            list.push({type:'W', args:[ms]});
            break;
          }
          case 'stop_motors': list.push({type:'S', args:[]}); break;
          case 'repeat_forever': {
            const inner=[]; let child=b.getInputTargetBlock('DO');
            while (child){ collect(child, inner); child = child.getNextBlock(); }
            list.push({type:'LOOP_INF', body:inner});
            break;
          }
          case 'wait_seconds': {
            const s = Number(Blockly.JavaScript.valueToCode(b,'SEC',Blockly.JavaScript.ORDER_NONE) || 0);
            list.push({type:'W', args:[s*1000]});
            break;
          }
        }
        collect(b.getNextBlock(), list);
      }
      collect(starts[0].getNextBlock(), prog);
      return prog;
    }

    // ì‹œì‘ í…œí”Œë¦¿
    const startXml = `
      <xml xmlns="https://developers.google.com/blockly/xml">
        <block type="xrobo_start" x="30" y="30">
          <next>
            <block type="repeat_forever">
              <statement name="DO">
                <block type="motor_wait">
                  <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
                  <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
                  <value name="DELAY"><shadow type="math_number"><field name="NUM">1000</field></shadow></value>
                  <next>
                    <block type="motor_wait">
                      <value name="M1"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                      <value name="M2"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                      <value name="DELAY"><shadow type="math_number"><field name="NUM">1000</field></shadow></value>
                      <next><block type="stop_motors"></block></next>
                    </block>
                  </next>
                </block>
              </statement>
            </block>
          </next>
        </block>
      </xml>`;
    Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(startXml), ws);

    /* ===== 2) Web Bluetooth ===== */
    const SERVICE_UUID = 0xFFF0; // MX-01 ê¸°ë³¸ ì„œë¹„ìŠ¤
    let bleDevice=null, bleServer=null, bleService=null, writeChar=null, notifyChar=null;
    const $ = id => document.getElementById(id);
    const log = m => { const L=$('log'); L.textContent += m+"\n"; L.scrollTop=L.scrollHeight; }
    const setUI = on => {
      $('disconnect').disabled=!on; $('run').disabled=!on; $('stop').disabled=!on;
      $('status').textContent = on ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°';
      $('status').className   = on ? 'status ok' : 'status';
    };
    const enc = s => new TextEncoder().encode(s);

    async function connectBLE(){
      if (!navigator.bluetooth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetooth ë¯¸ì§€ì›ì…ë‹ˆë‹¤.');
      const wantName = $('devName').value.trim();
      try{
        log('â³ BLE ìŠ¤ìº”â€¦');
        const dev = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID]
        });
        if (wantName && dev.name !== wantName) {
          log(`ì„ íƒ ê¸°ê¸°: ${dev.name||'(ì—†ìŒ)'} â†’ ì…ë ¥ ì´ë¦„ê³¼ ë¶ˆì¼ì¹˜`); alert('íŒì—…ì—ì„œ ë³¸ì¸ ê¸°ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”!'); return;
        }
        bleDevice = dev;
        bleDevice.addEventListener('gattserverdisconnected', ()=>{ setUI(false); log('ğŸ”Œ í•´ì œë¨'); });
        bleServer  = await bleDevice.gatt.connect();
        bleService = await bleServer.getPrimaryService(SERVICE_UUID);
        try{ writeChar = await bleService.getCharacteristic(0xFFF3); }catch(_){}
        try{ notifyChar= await bleService.getCharacteristic(0xFFF4); }catch(_){}
        if (!writeChar || notifyChar==null){
          const chars = await bleService.getCharacteristics();
          for (const ch of chars){
            const p = ch.properties;
            if (!writeChar && (p.write || p.writeWithoutResponse)) writeChar = ch;
            if (!notifyChar && p.notify) notifyChar = ch;
          }
        }
        if (!writeChar) throw new Error('write ê°€ëŠ¥í•œ íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        if (notifyChar){
          await notifyChar.startNotifications();
          notifyChar.addEventListener('characteristicvaluechanged', ev=>{
            const v = new TextDecoder().decode(ev.target.value);
            log('â¬…ï¸ Notify: ' + v);
          });
        }
        setUI(true);
        log('âœ… ì—°ê²° ì„±ê³µ: ' + (dev.name || '(ì´ë¦„ ì—†ìŒ)'));
      }catch(e){ console.error(e); log('âŒ ì—°ê²° ì‹¤íŒ¨: '+e); setUI(false); }
    }

    function disconnectBLE(){ try{ bleDevice?.gatt?.disconnect(); }catch(_){} setUI(false); }

    async function sendCmd(s){
      if (!writeChar) throw new Error('BLE ë¯¸ì—°ê²°');
      await writeChar.writeValue(enc(s+'\n'));
      log('â¡ï¸ ' + s);
    }

    /* ===== 3) ì‹¤í–‰ê¸° ===== */
    let running = false;
    async function runProgram(){
      if (!writeChar) return alert('ë¨¼ì € BLE ì—°ê²°!');
      const prog = blocksToProgram();
      if (!prog.length) return alert('ì‹¤í–‰í•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n"XROBO start" ì•„ë˜ì— ë¸”ë¡ì„ ì—°ê²°í•˜ì„¸ìš”.');
      running = true; $('stop').disabled=false;

      async function execList(list){
        for (let i=0; i<list.length && running; i++){
          const ins = list[i];
          if (ins.type==='M'){
            const [a,b] = ins.args;
            await sendCmd(`M ${Math.round(a)} ${Math.round(b)}`);
          } else if (ins.type==='W'){
            const [ms] = ins.args;
            await new Promise(r=>setTimeout(r, Math.max(0, ms)));
          } else if (ins.type==='S'){
            await sendCmd('S');
          } else if (ins.type==='LOOP_INF'){
            while (running){ await execList(ins.body); }
          }
        }
      }
      try { await execList(prog); }
      catch(e){ console.error(e); log('âš ï¸ ì‹¤í–‰ ì˜¤ë¥˜: '+e); }
      running=false; $('stop').disabled=true;
    }
    function stopProgram(){ running=false; if (writeChar) sendCmd('S').catch(()=>{}); }

    /* ===== 4) ì „ì²´í™”ë©´ í† ê¸€ ===== */
    const fsBtn = document.getElementById('fsBtn');
    async function enterFullscreen() { const el = document.documentElement; if (el.requestFullscreen) await el.requestFullscreen(); }
    async function exitFullscreen() { if (document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }
    fsBtn.onclick = async () => { if (document.fullscreenElement) { await exitFullscreen(); } else { await enterFullscreen(); } queueResize(); };
    document.addEventListener('fullscreenchange', () => {
      const active = !!document.fullscreenElement;
      document.body.classList.toggle('fs-active', active);
      fsBtn.textContent = active ? 'ë‚˜ê°€ê¸°' : 'ğŸ–µ ì „ì²´í™”ë©´';
      fsBtn.title = active ? 'ì „ì²´í™”ë©´ ì¢…ë£Œ' : 'ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜';
      queueResize();
    });

    /* ===== 5) ì‹¤í–‰ì°½ ì—´/ë‹« í† ê¸€ (ì½”ë”©ì°½ ìš°ìƒë‹¨ ê³ ì •) ===== */
    const panelToggle = document.getElementById('panelToggle');
    function updatePanelBtn(){
      const closed = document.body.classList.contains('panel-collapsed');
      panelToggle.textContent = closed ? 'â—€ ì‹¤í–‰ì°½ ì—´ê¸°' : 'â–¶ ì‹¤í–‰ì°½ ë‹«ê¸°';
      panelToggle.title = closed ? 'ì‹¤í–‰ì°½ ì—´ê¸°' : 'ì‹¤í–‰ì°½ ë‹«ê¸°';
    }
    panelToggle.onclick = () => {
      document.body.classList.toggle('panel-collapsed');
      updatePanelBtn();
      queueResize();
    };
    updatePanelBtn();

    /* ===== 6) UI â†” Blockly ì¤Œ ë™ê¸°í™” =====
       - Blocklyì˜ + / - / ë§ˆìš°ìŠ¤íœ  ì¤Œ ì‹œ UIë„ ê°™ì€ ë°°ìœ¨ë¡œ ìŠ¤ì¼€ì¼
       - í—¤ë”(#headerInner), ì˜¤ë¥¸ìª½ ë‚´ìš©(#rightInner), íŒ¨ë„ í† ê¸€(#panelToggle)
    */
    function applyUiScale(scale){
      // ë„ˆë¬´ ì‘ê±°ë‚˜ í¬ê²Œ ë³´ì´ëŠ” ê²ƒ ë°©ì§€ (í•„ìš” ì‹œ ì¡°ì ˆ)
      const clamped = Math.max(0.8, Math.min(1.6, scale));
      document.documentElement.style.setProperty('--uiScale', clamped);
    }
    function syncUiScaleFromWorkspace(){
      applyUiScale(ws.getScale());
    }
    ws.addChangeListener((ev)=>{
      // Blockly.Events.UI with element === 'zoom'
      if (ev && ev.type === Blockly.Events.UI && ev.element === 'zoom') {
        syncUiScaleFromWorkspace();
      }
    });

    /* ===== 7) Blockly ë¦¬ì‚¬ì´ì¦ˆ í—¬í¼ ===== */
    let resizeTimer = null;
    function queueResize(){
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>Blockly.svgResize(ws), 60);
    }
    window.addEventListener('resize', queueResize);
    // ì´ˆê¸° ë™ê¸°í™”
    syncUiScaleFromWorkspace();
    queueResize();

    /* ===== 8) ë²„íŠ¼ ë°”ì¸ë”© ===== */
    document.getElementById('connect').onclick = connectBLE;
    document.getElementById('disconnect').onclick = disconnectBLE;
    document.getElementById('run').onclick = runProgram;
    document.getElementById('stop').onclick = stopProgram;

    setUI(false);
  </script>
</body>
</html>
