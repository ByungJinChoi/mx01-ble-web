<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MX-01 BLE ë¦¬ëª¨ì»¨</title>
<style>
  body{font-family:system-ui,sans-serif;margin:16px;line-height:1.45}
  input,button{font-size:16px;padding:10px 12px;border-radius:10px}
  button{border:0;cursor:pointer;margin-right:8px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  #connect{background:#2563eb;color:#fff} #disconnect{background:#475569;color:#fff}
  #on{background:#16a34a;color:#fff} #off{background:#ef4444;color:#fff}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:#eee}
  .ok{background:#d1fae5}
  .log{white-space:pre-wrap;background:#f7f7f7;border-radius:8px;padding:10px;font-family:ui-monospace,monospace;font-size:13px;margin-top:12px;max-height:160px;overflow:auto}
</style>
<body>
<h2>MX-01 BLE ë¦¬ëª¨ì»¨</h2>
<p>HTTPS(ì´ í˜ì´ì§€)ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤. ê¸°ê¸° ì´ë¦„ì„ ìœ ë‹ˆí¬í•˜ê²Œ ë°”ê¾¸ê³ (ì˜ˆ: <code>MX-AB12</code>), ì•„ë˜ì— ì…ë ¥í•œ ë’¤ ì—°ê²°í•˜ì„¸ìš”.</p>

<div style="margin:8px 0">
  <label>ë‚´ ê¸°ê¸° ì´ë¦„(ì •í™•íˆ): <input id="devName" placeholder="MX-AB12"></label>
</div>

<div>
  <button id="connect">ğŸ”— ì—°ê²°</button>
  <button id="disconnect" disabled>âŒ í•´ì œ</button>
  <span id="status" class="badge">ë¯¸ì—°ê²°</span>
</div>

<div style="margin-top:10px">
  <button id="on"  disabled>ğŸ’¡ LED ON ("1")</button>
  <button id="off" disabled>ğŸ’¤ LED OFF ("0")</button>
</div>

<div class="log" id="log"></div>

<script>
const SERVICE_UUID = 0xFFF0; // MX-01 ê¸°ë³¸ ì„œë¹„ìŠ¤ (íŒì›¨ì–´ì— ë”°ë¼ ë‹¤ë¥´ë©´ ë°”ê¾¸ì„¸ìš”)
let device, server, service, writeChar, notifyChar;

const $ = id => document.getElementById(id);
const log = m => { const L=$("log"); L.textContent += m + "\n"; L.scrollTop=L.scrollHeight; }
const setUI = on => {
  $("status").textContent = on ? "ì—°ê²°ë¨" : "ë¯¸ì—°ê²°";
  $("status").className = on ? "badge ok" : "badge";
  $("disconnect").disabled = !on;
  $("on").disabled = !on; $("off").disabled = !on;
};
function enc(s){ return new TextEncoder().encode(s); }

async function connectBLE(){
  if(!navigator.bluetooth){ alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetooth ë¯¸ì§€ì›ì…ë‹ˆë‹¤."); return; }
  const wantName = $("devName").value.trim();
  if(!wantName){ alert("ë‚´ ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

  try{
    // ëª¨ë“  ì¥ì¹˜ë¥¼ ë³´ì—¬ì£¼ë˜, íŒì—…ì—ì„œ ì‚¬ìš©ìê°€ "ìê¸° ê¸°ê¸°"ë¥¼ ì„ íƒí•˜ë„ë¡ ìœ ë„
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID],
    });
    if (device.name !== wantName) {
      log(`ì„ íƒëœ ê¸°ê¸°: ${device.name || "(ì´ë¦„ ì—†ìŒ)"} â†’ ì…ë ¥í•œ ì´ë¦„ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.`);
      alert("íŒì—…ì—ì„œ ë³¸ì¸ ê¸°ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
      return;
    }
    device.addEventListener("gattserverdisconnected", ()=>{ setUI(false); log("ğŸ”Œ í•´ì œë¨"); });

    server  = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);

    // 1) í”í•œ ì¡°í•© ì‹œë„ (FFF3: Write, FFF4: Notify)
    try { writeChar = await service.getCharacteristic(0xFFF3); } catch(_) {}
    try { notifyChar= await service.getCharacteristic(0xFFF4); } catch(_) {}

    // 2) ì‹¤íŒ¨ ì‹œ ìë™ íƒì§€ (íŒì›¨ì–´ì— ë”°ë¼ FFF1/FFF2 ë“±ì¼ ìˆ˜ ìˆìŒ)
    if(!writeChar || notifyChar==null){
      const chars = await service.getCharacteristics();
      for(const ch of chars){
        const p = ch.properties;
        if(!writeChar && (p.write || p.writeWithoutResponse)) writeChar = ch;
        if(!notifyChar && p.notify) notifyChar = ch;
      }
    }
    if(!writeChar) throw new Error("write ê°€ëŠ¥í•œ íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

    if(notifyChar){
      await notifyChar.startNotifications();
      notifyChar.addEventListener("characteristicvaluechanged", ev=>{
        const v = new TextDecoder().decode(ev.target.value);
        log("â¬…ï¸ Notify: " + v);
      });
    }

    setUI(true);
    log("âœ… ì—°ê²° ì„±ê³µ: " + (device.name || "(ì´ë¦„ ì—†ìŒ)"));
  }catch(e){ console.error(e); log("âŒ ì—°ê²° ì‹¤íŒ¨: " + e); setUI(false); }
}

async function send(val){
  if(!writeChar){ alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”."); return; }
  try{ await writeChar.writeValue(enc(val)); log(`â¡ï¸ "${val}" ì „ì†¡`); }
  catch(e){ console.error(e); log("âš ï¸ ì „ì†¡ ì‹¤íŒ¨: " + e); }
}

$("connect").onclick = connectBLE;
$("disconnect").onclick = ()=>{ try{ device?.gatt?.disconnect(); }catch(_){} setUI(false); };
$("on").onclick  = ()=>send("1");
$("off").onclick = ()=>send("0");
setUI(false);
</script>
</body>
</html>
