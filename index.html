<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO BLE</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  :root{
    --pad:10px;
    --uiScale: 1;
    --headerH: 64px;
    --btnH: 36px;
    --gap: 8px;
    --headerBgTop: #fff7ed;
    --headerBgBottom: #fffbeb;
    --headerBorder: #fed7aa;
    --logH: 180px;
    --blue: #1d4ed8;
    --servoScale: 0.7;
  }
  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{ margin:0; font-family:system-ui, sans-serif; background:#fff; }

  header{ padding:8px 12px; background:linear-gradient(180deg,var(--headerBgTop),var(--headerBgBottom)); border-bottom:1px solid var(--headerBorder); position:relative; z-index:10; }
  #topbar{ display:flex; align-items:center; gap: calc(var(--gap) * var(--uiScale)); flex-wrap: wrap; }
  .title{ font-weight:800; color:#7c2d12; margin-right:12px; font-size:calc(18px * var(--uiScale)); }
  .spacer{ flex:1 1 auto; }
  .btn{ height:calc(var(--btnH) * var(--uiScale)); padding:0 calc(12px * var(--uiScale)); border:0; border-radius:calc(10px * var(--uiScale)); display:inline-flex; align-items:center; justify-content:center; font-size:calc(14px * var(--uiScale)); font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.08); background:#f3f4f6; color:#111827; cursor:pointer; user-select:none; }
  #connectToggle{ background:#2563eb; color:#fff; }
  #runToggle{ background:#16a34a; color:#fff; }
  #fsBtn{ background:#111827; color:#fff; }
  .state{ display:inline-flex; align-items:center; gap:calc(6px * var(--uiScale)); height:calc(var(--btnH) * var(--uiScale)); padding:0 calc(6px * var(--uiScale)); font-size:calc(12px * var(--uiScale)); }
  .badgeDot{ width:calc(22px * var(--uiScale)); height:calc(22px * var(--uiScale)); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:calc(11px * var(--uiScale)); font-weight:800; color:#fff; box-shadow:0 0 0 calc(4px * var(--uiScale)) rgba(0,0,0,.06) inset; }
  .badgeDot.on{ background:#3b82f6; } .badgeDot.off{ background:#ef4444; }

  #main{ display:flex; width:100%; height: calc(100vh - var(--headerH)); min-height: 0; }
  #left{ position:relative; flex:1 1 auto; min-width:0; height:100%; display:flex; overflow:visible; }
  #blocklyDiv{ flex:1 1 auto; min-width:0; height:100%; width:100%; }
  #right{ flex:0 0 40%; display:flex; flex-direction:column; background:#fff; margin:8px 8px 8px 0; border:1px solid #e5e7eb; border-left:3px solid var(--blue); border-radius:12px 0 0 12px; box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden; position:relative; min-height:0; }
  #rightTop{ flex:1 1 auto; min-height:0; border-bottom:1px solid #e5e7eb; background:#f5f7fa; color:#111827; font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace; font-size: calc(13px * var(--uiScale)); line-height:1.45; padding: calc(12px * var(--uiScale)); overflow:auto; white-space:pre; tab-size:2; }
  #rightBottom{ flex:0 0 var(--logH); display:flex; flex-direction:column; min-height:0; overflow:hidden; padding:calc(10px * var(--uiScale)); background:#0b0f14; color:#d1e4ff; border-top:1px solid #1f2937; }
  #log{ flex:1 1 0; min-height:0; overflow:auto; white-space:pre-wrap; background:#0b0f14; border:1px solid #1f2937; border-radius: calc(8px * var(--uiScale)); padding: calc(10px * var(--uiScale)); font-family: ui-monospace, Menlo, Consolas, monospace; font-size: calc(12px * var(--uiScale)); color:#d1e4ff; }

  #panelHandle{ position:absolute; top:12px; right:0; z-index:9999; width:24px; height:28px; background: var(--blue); border:0; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,.18); cursor:pointer; padding:0; }
  #panelHandle::after{ content:''; position:absolute; top:50%; left:7px; transform:translateY(-50%); width:0; height:0; border-style:solid; border-width:6px 0 6px 8px; border-color: transparent transparent transparent #fff; }
  body.panel-collapsed #right{ display:none; } body.panel-collapsed #left{ flex:1 1 100%; }
</style>
</head>
<body>
  <header id="appHeader">
    <div id="topbar">
      <div class="title">XROBO BLE</div>
      <div class="spacer"></div>
      <button id="saveBtn" class="btn" title="ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•">Ï†ÄÏû•</button>
      <button id="loadBtn" class="btn" title="ÌîÑÎ°úÏ†ùÌä∏ Î∂àÎü¨Ïò§Í∏∞">Î∂àÎü¨Ïò§Í∏∞</button>
      <span class="state"><span id="statusDot" class="badgeDot off">off</span></span>
      <button id="connectToggle" class="btn">Ïó∞Í≤∞</button>
      <button id="runToggle" class="btn" disabled>‚ñ∂ Ïã§Ìñâ</button>
      <button id="fsBtn" class="btn" title="Ï†ÑÏ≤¥ÌôîÎ©¥">Ï†ÑÏ≤¥ÌôîÎ©¥</button>
    </div>
  </header>

  <div id="main">
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelHandle" title="Ïã§ÌñâÏ∞Ω Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞"></button>
    </div>
    <div id="right">
      <div id="rightTop"></div>
      <div id="rightBottom">
        <div style="font-size:calc(12px * var(--uiScale));color:#9ca3af;">Ïã§Ìñâ Î°úÍ∑∏</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <xml id="toolbox" style="display:none">
    <category name="Ïù¥Î≤§Ìä∏" colour="#f59e0b"><block type="xrobo_start"></block></category>

    <category name="ÏûÖÎ†•" colour="#06b6d4">
      <block type="in_xkeypad"><field name="PIN">IN1</field><field name="BTN">B1</field></block>
      <block type="in_ir_dist"><field name="PIN">IN1</field>
        <value name="DIST"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="in_touch"><field name="PIN">IN1</field></block>
    </category>

    <category name="Ï∂úÎ†•" colour="#60a5fa">
      <block type="motor12_dd"><field name="M1">20</field><field name="M2">20</field><field name="MS">500</field></block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="motor34_dd"><field name="M3">20</field><field name="M4">20</field><field name="MS">500</field></block>
      <block type="motor34_in">
        <value name="M3"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M4"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>

      <block type="servo_dd"><field name="OUT">OUT1</field><field name="ANG">90</field></block>
      <block type="servo_in"><field name="OUT">OUT1</field>
        <value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>
      <block type="servo_slow"><field name="OUT">OUT1</field>
        <value name="DELAY"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
        <value name="ANG"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>

      <block type="melody"><field name="PITCH">C4</field>
        <value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value>
        <value name="WAIT"><shadow type="math_number"><field name="NUM">250</field></shadow></value></block>

      <block type="led_ctrl">
        <field name="TGT">CPU</field>
        <field name="VAL">0</field>
      </block>

      <block type="multi_servo"></block>
    </category>

    <category name="Ï†úÏñ¥" colour="#10b981">
      <block type="wait_seconds"><value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
      <block type="repeat_forever"></block>
      <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>
    </category>

    <category name="Î≥ÄÏàò" colour="#f97316" custom="VARIABLE"></category>
    <category name="ÎÇ¥Î∏îÎ°ù" colour="#ef4444" custom="PROCEDURE"></category>
  </xml>

<script>
/* ============ Blockly ÏÑ§Ï†ï ============ */
class XroboZelosProvider extends Blockly.zelos.ConstantProvider { constructor(){ super(); this.ADD_START_HATS = true; } }
class XroboZelosRenderer extends Blockly.zelos.Renderer { constructor(){ super('xrobo_zelos'); } makeConstants_(){ return new XroboZelosProvider(); } }
Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);
const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', { base: Blockly.Themes.Zelos, componentStyles: { startHats: true } });

const ws = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox'), renderer: 'xrobo_zelos', theme: XroboTheme,
  grid: { spacing:20, length:3, colour:'#eee', snap:true }, zoom: { controls:true, wheel:true } });

/* ============ Î∏îÎ°ù Ï†ïÏùò ============ */
const PINS_IN=[["IN1","IN1"],["IN2","IN2"],["IN3","IN3"],["IN4","IN4"]];
const PINS_OUT=[["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
const KEYS_B=[["B1","B1"],["B2","B2"],["B3","B3"],["B4","B4"],["B5","B5"]];
const SPEEDS=Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
const TIMES100=Array.from({length:10},(_,i)=>(100*(i+1))).map(v=>[String(v),String(v)]);
const ANG_5=Array.from({length:37},(_,i)=>i*5).map(v=>[String(v),String(v)]);
const LED_TGT=[["CPU","CPU"],["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
const LED_VALS=Array.from({length:21},(_,i)=>[i===20?'Ïà®Ïâ¨Í∏∞':String(i), String(i)]);
const PITCHES=(()=>{const KR=["ÎèÑ","Î†à","ÎØ∏","Ìåå","ÏÜî","Îùº","Ïãú"],EN=["C","D","E","F","G","A","B"],L=[]; for(let o=4;o<=6;o++) for(let i=0;i<7;i++) L.push([`${KR[i]}${o}`, `${EN[i]}${o}`]); return L;})();

Blockly.defineBlocksWithJsonArray([
  { "type":"xrobo_start", "message0":"XROBO start", "nextStatement":null, "colour":36, "hat":"cap" },

  { "type":"in_xkeypad", "message0":"X ÌÇ§Ìå®Îìú ÌïÄ %1 Î≤ÑÌäº %2",
    "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN},{"type":"field_dropdown","name":"BTN","options":KEYS_B}],
    "output":"Boolean","colour":198 },

  { "type":"in_ir_dist", "message0":"Ï†ÅÏô∏ÏÑ†ÏÑºÏÑú ÌïÄ %1 Í±∞Î¶¨ %2 Ïù¥ÎÇ¥",
    "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN},{"type":"input_value","name":"DIST","check":"Number"}],
    "output":"Boolean","colour":198 },

  { "type":"in_touch", "message0":"Ï†ëÏ¥âÏÑºÏÑú ÌïÄ %1 ÎàåÎ¶º",
    "args0":[{"type":"field_dropdown","name":"PIN","options":PINS_IN}],
    "output":"Boolean","colour":198 },

  { "type":"motor12_dd","message0":"Î™®ÌÑ∞ M1 %1  M2 %2  ÏãúÍ∞Ñ %3 ms",
    "args0":[{"type":"field_dropdown","name":"M1","options":SPEEDS},{"type":"field_dropdown","name":"M2","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

  { "type":"motor12_in","message0":"Î™®ÌÑ∞ M1 %1  M2 %2  ÏãúÍ∞Ñ %3 ms",
    "args0":[{"type":"input_value","name":"M1","check":"Number"},{"type":"input_value","name":"M2","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

  { "type":"motor34_dd","message0":"Î™®ÌÑ∞ M3 %1  M4 %2  ÏãúÍ∞Ñ %3 ms",
    "args0":[{"type":"field_dropdown","name":"M3","options":SPEEDS},{"type":"field_dropdown","name":"M4","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

  { "type":"motor34_in","message0":"Î™®ÌÑ∞ M3 %1  M4 %2  ÏãúÍ∞Ñ %3 ms",
    "args0":[{"type":"input_value","name":"M3","check":"Number"},{"type":"input_value","name":"M4","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },

  { "type":"servo_dd","message0":"ÏÑúÎ≥¥Î™®ÌÑ∞ %1 Í∞ÅÎèÑ %2¬∞",
    "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"field_dropdown","name":"ANG","options":ANG_5}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },

  { "type":"servo_in","message0":"ÏÑúÎ≥¥Î™®ÌÑ∞ %1 Í∞ÅÎèÑ %2¬∞",
    "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"input_value","name":"ANG","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },

  { "type":"servo_slow","message0":"Ïä¨Î°úÏö∞ ÏÑúÎ≥¥ %1 ÏßÄÏó∞ %2 ms Í∞ÅÎèÑ %3¬∞",
    "args0":[{"type":"field_dropdown","name":"OUT","options":PINS_OUT},{"type":"input_value","name":"DELAY","check":"Number"},{"type":"input_value","name":"ANG","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":30 },

  { "type":"melody","message0":"Î©úÎ°úÎîî ÏùåÎÜíÏù¥ %1 ÏÜåÎ¶¨ÏãúÍ∞Ñ %2 ms ÎåÄÍ∏∞ÏãúÍ∞Ñ %3 ms",
    "args0":[{"type":"field_dropdown","name":"PITCH","options":PITCHES},{"type":"input_value","name":"DUR","check":"Number"},{"type":"input_value","name":"WAIT","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":300 },

  { "type":"led_ctrl","message0":"LED %1 Í∞í %2",
    "args0":[{"type":"field_dropdown","name":"TGT","options":LED_TGT},{"type":"field_dropdown","name":"VAL","options":LED_VALS}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":330
  },

  { "type":"multi_servo","message0":"Î©ÄÌã∞ ÏÑúÎ≥¥ (Í∞úÏàò: %1)  %2 %3",
    "args0":[
      { "type":"field_label_serializable", "name":"COUNT", "text":"0" },
      { "type":"field_image", "name":"CFG","src":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'><path fill='%23000' d='M10.325 4.317a1 1 0 0 1 1.35-.447l.162.08l1.028.514a8.9 8.9 0  0 1 1.46-.419l.21-1.146A1 1 0  0 1 15.52 2h2.96a1 1 0  0 1 .986.836l.21 1.146c.514.126 1.007.297 1.46.52l1.029-.515a1 1 0  0 1 1.33.427l1.48 2.564a1 1 0  0 1-.255 1.287l-.94.767c.082.5.124 1.013.124 1.535s-.042 1.035-.124 1.535l.94.767a1 1 0  0 1 .255 1.287l-1.48 2.564a1 1 0  0 1-1.33.427l-1.028-.515a8.9 8.9 0  0  1-1.46.52l-.21 1.145A1 1 0  0 1 18.48 22h-2.96a1 1 0  0  1-.986-.836l-.21-1.145a8.9 8.9 0  0  1-1.459-.419l-1.028.514a1 1 0  0 1-1.35-.447l-1.48-2.564a1 1 0  0 1 .255-1.287l.94-.767A7.91 7.91 0  0  1 10 12c0-.522.042-1.035.124-1.535l-.94-.767a1 1 0  0  1-.255-1.287zM17 9a3 3 0  1 0 0 6a3 3 0  0  0 0-6' /></svg>","width":20,"height":20,"alt":"ÏÑ§Ï†ï" },
      { "type":"field_image", "name":"DUP","src":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'><path fill='%23000' d='M16 1H4a2 2 0  0  0-2 2v12h2V3h12z'/><path fill='%23000' d='M20 5H8a2 2 0  0 0-2 2v14h14a2 2 0  0 0 2-2V7a2 2 0  0 0-2-2m0 16H8V7h12z'/></svg>","width":20,"height":20,"alt":"Î≥µÏÇ¨" }
    ],
    "previousStatement":null, "nextStatement":null, "colour": 30, "extensions": ["multi_servo_cfg"]
  },

  { "type":"wait_seconds","message0":"%1 Ï¥à Í∏∞Îã§Î¶¨Í∏∞","args0":[{"type":"input_value","name":"SEC","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"colour":160 },
  { "type":"repeat_forever","message0":"Í≥ÑÏÜç Î∞òÎ≥µÌïòÍ∏∞ %1 %2",
    "args0":[{"type":"input_dummy"},{"type":"input_statement","name":"DO"}],
    "previousStatement":null,"nextStatement":null,"colour":160 }
]);

/* Î©ÄÌã∞ ÏÑúÎ≥¥ ÌôïÏû• (UIÎßå ÌïÑÏöîÌïòÎØÄÎ°ú Í∞ÑÍ≤∞Ìôî) */
const multiServoConfigs = new Map();
Blockly.Extensions.register('multi_servo_cfg', function (){
  const cfgBtn = this.getField('CFG');
  const dupBtn = this.getField('DUP');
  if (cfgBtn?.setOnClickHandler) cfgBtn.setOnClickHandler(() => alert('ÏÑ§Ï†ï Î™®Îã¨ÏùÄ ÏÉùÎûµÎêòÏóàÏäµÎãàÎã§.'));
  if (dupBtn?.setOnClickHandler) dupBtn.setOnClickHandler(() => {
    const pos = this.getRelativeToSurfaceXY();
    const b = ws.newBlock('multi_servo'); b.initSvg(); b.render(); b.moveBy(pos.x+30,pos.y+30); b.setFieldValue('0','COUNT'); b.select();
  });
});

/* === ÏΩîÎìú Î≥ÄÌôò === */
function numFromInput(parent, name, def=0){
  const n = Number(Blockly.JavaScript.valueToCode(parent, name, Blockly.JavaScript.ORDER_NONE) ?? '');
  return Number.isFinite(n) ? n : def;
}
function outToS(out){ const m=String(out||'').match(/^OUT(\d)$/); return m ? ('S'+m[1]) : String(out||''); }
const clampAng180 = a => Math.max(0, Math.min(180, Math.round(Number(a)||0)));

function walkNode(b, list){
  if(!b) return;
  switch(b.type){
    case 'motor12_dd':{
      const v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS');
      list.push({type:'CMD',s:`M12 ${v1} ${v2} ${ms}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
    case 'motor12_in':{
      const v1=numFromInput(b,'M1',0),v2=numFromInput(b,'M2',0),ms=numFromInput(b,'MS',0);
      list.push({type:'CMD',s:`M12 ${Math.round(v1)} ${Math.round(v2)} ${Math.round(ms)}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
    case 'motor34_dd':{
      const v3=+b.getFieldValue('M3'),v4=+b.getFieldValue('M4'),ms=+b.getFieldValue('MS');
      list.push({type:'CMD',s:`M34 ${v3} ${v4} ${ms}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
    case 'motor34_in':{
      const v3=numFromInput(b,'M3',0),v4=numFromInput(b,'M4',0),ms=numFromInput(b,'MS',0);
      list.push({type:'CMD',s:`M34 ${Math.round(v3)} ${Math.round(v4)} ${Math.round(ms)}`}); if(ms>0) list.push({type:'W',args:[ms]}); break; }

    case 'servo_dd':{
      const out=b.getFieldValue('OUT'),ang=+b.getFieldValue('ANG');
      const S=outToS(out), A=clampAng180(ang);
      list.push({type:'CMD',s:`SV ${S} ${A}`}); break; }
    case 'servo_in':{
      const out=b.getFieldValue('OUT'),ang=numFromInput(b,'ANG',90);
      const S=outToS(out), A=clampAng180(ang);
      list.push({type:'CMD',s:`SV ${S} ${A}`}); break; }
    case 'servo_slow':{
      const out=b.getFieldValue('OUT'),del=numFromInput(b,'DELAY',5),ang=numFromInput(b,'ANG',90);
      const S=outToS(out), D=Math.max(0, Math.min(180, Math.round(del))), A=clampAng180(ang);
      list.push({type:'CMD',s:`SVS ${S} ${D} ${A}`}); break; }

    case 'melody':{
      const p=b.getFieldValue('PITCH'),dur=numFromInput(b,'DUR',200),wait=numFromInput(b,'WAIT',250);
      list.push({type:'CMD',s:`MEL ${p} ${Math.round(dur)} ${Math.round(wait)}`}); if(wait>0) list.push({type:'W',args:[wait]}); break; }

    case 'led_ctrl':{
      const t=b.getFieldValue('TGT'); const v=b.getFieldValue('VAL');
      let ch=0; if(t==='CPU') ch=0; else{ const m=t.match(/^OUT(\d)$/); ch=m?parseInt(m[1],10):0; }
      list.push({type:'CMD', s:`LED ${ch} ${v}`}); break;
    }

    case 'repeat_forever':{
      const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
      list.push({type:'LOOP_INF',body:inner}); break; }
    case 'controls_repeat_ext':{
      const times=Math.max(0, numFromInput(b,'TIMES',1));
      const inner=[]; const first=b.getInputTargetBlock('DO'); walkChain(first, inner);
      list.push({type:'FOR',count:times,body:inner}); break; }
    case 'wait_seconds':{
      const s=numFromInput(b,'SEC',1);
      if(s>0) list.push({type:'W',args:[s*1000]});
      break; }
  }
}
function walkChain(start, list){ for(let n=start; n; n=n.getNextBlock()) walkNode(n, list); }

function normalizeProgram(list){
  const out=[];
  for(const ins of list){
    if(ins.type==='CMD'){
      const prev=out[out.length-1];
      if(prev && prev.type==='CMD' && prev.s===ins.s) continue;
    }else if(ins.type==='W'){
      if(!Number.isFinite(ins.args?.[0])||ins.args[0]<=0) continue;
      const prev=out[out.length-1];
      if(prev && prev.type==='W'){ prev.args[0]+=ins.args[0]; continue; }
    }
    out.push(ins);
  }
  return out;
}
function firstExecutableTopStack(){
  const tops=ws.getTopBlocks(true);
  for(const b of tops){
    if(!b.outputConnection&&(b.nextConnection||b.statementInputCount>0||b.type==='xrobo_start')) return b;
  }
  return null;
}
function blocksToProgram(){
  const starts=ws.getBlocksByType('xrobo_start',true);
  let entry=null, startChain=null;
  if(starts.length){ entry=starts[0]; startChain=entry.getNextBlock(); }
  else{ entry=firstExecutableTopStack(); startChain=entry; }
  if(!entry) return [];
  const prog=[]; walkChain(startChain, prog);
  return normalizeProgram(prog);
}
function programToC(prog){
  const out=['void setup() {','  // TODO: ÌïÄ Ï¥àÍ∏∞Ìôî','}','', 'void loop() {'];
  const emit=(list,indent='  ')=>{
    for(const ins of list){
      if(ins.type==='CMD'){ out.push(`${indent}send("${ins.s}");`); }
      else if(ins.type==='W'){ out.push(`${indent}delay(${ins.args[0]});`); }
      else if(ins.type==='FOR'){ out.push(`${indent}for (int i=0; i<${ins.count}; ++i) {`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
      else if(ins.type==='LOOP_INF'){ out.push(`${indent}while(true){`); emit(ins.body,indent+'  '); out.push(`${indent}}`); }
    }
  };
  emit(prog,'  '); out.push('}'); return out.join('\n');
}
const codeView=document.getElementById('rightTop');
let refreshTimer=null;
function refreshCodeDebounced(){ clearTimeout(refreshTimer); refreshTimer=setTimeout(()=>{ codeView.textContent=programToC(blocksToProgram()); },100); }
ws.addChangeListener(refreshCodeDebounced); refreshCodeDebounced();

/* ============ BLE ÌÜµÏã† (ÏàòÏ†ïÎ≥∏) ============ */
const SERVICE_UUID = 0xFFF0;
let bleDevice=null, bleServer=null, bleService=null;
let writeChar=null, notifyChar=null, canWriteWO=false;
let isConnected=false, isRunning=false;
let connectToken=0, runToken=0;

const log=m=>{ const L=document.getElementById('log'); L.textContent+=m+"\\n"; L.scrollTop=L.scrollHeight; };
const enc = s => new TextEncoder().encode(s);
const btnConnect=document.getElementById('connectToggle');
const btnRun=document.getElementById('runToggle');
const dot=document.getElementById('statusDot');

const txQueue = []; let txBusy=false;
async function txWorker(){
  if(txBusy) return; txBusy=true;
  try{
    while(isConnected && txQueue.length){
      const line = txQueue.shift();
      if(!writeChar) break;
      try{
        if(canWriteWO && writeChar.writeValueWithoutResponse){
          await writeChar.writeValueWithoutResponse(enc(line));
        }else{
          await writeChar.writeValue(enc(line));
        }
        log('‚û°Ô∏è '+line.trim());
      }catch(e){ log('‚ö†Ô∏è Ï†ÑÏÜ° Ïã§Ìå®: '+e); }
      await new Promise(r=>setTimeout(r,25));
    }
  }finally{ txBusy=false; }
}
function sendLine(line){
  if(!isConnected || !writeChar) return;
  txQueue.push(line.endsWith('\\n')?line:(line+'\\n')); txWorker();
}

function setConnected(v){
  isConnected=v;
  btnConnect.textContent=v?'Ìï¥Ï†ú':'Ïó∞Í≤∞';
  btnRun.disabled=!v;
  dot.classList.toggle('on',v); dot.classList.toggle('off',!v);
  dot.textContent=v?'on':'off';
  if(!v){ setRunning(false); txQueue.length=0; }
}
function setRunning(v){ isRunning=v; btnRun.textContent=v?'‚ñ† Ï†ïÏßÄ':'‚ñ∂ Ïã§Ìñâ'; btnRun.style.background=v?'#ef4444':'#16a34a'; }

function onDisconnected(ev){
  if(bleDevice && ev?.target && ev.target !== bleDevice) return;
  log('üîå Ìï¥Ï†úÎê®');
  setConnected(false);
  writeChar = notifyChar = null; canWriteWO=false;
}

async function pickWriteCharacteristic(service){
  let w=null,n=null,wwo=false;
  try{ w=await service.getCharacteristic(0xFFF3); }catch(_){}
  try{ n=await service.getCharacteristic(0xFFF4); }catch(_){}
  if(w){ const p=w.properties||{}; wwo=!!p.writeWithoutResponse; return {w,n,wwo}; }
  const chars=await service.getCharacteristics();
  for(const ch of chars){
    const p=ch.properties||{};
    if((p.writeWithoutResponse||p.write)&&!w){ w=ch; wwo=!!p.writeWithoutResponse; }
    if(p.notify && !n){ n=ch; }
  }
  return {w,n,wwo};
}

async function connectBLE(){
  if(!navigator.bluetooth){ alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Web Bluetooth ÎØ∏ÏßÄÏõêÏûÖÎãàÎã§.'); return; }
  const myToken=++connectToken;
  try{
    const dev = await navigator.bluetooth.requestDevice({ filters:[{ namePrefix:'XROBO' }], optionalServices:[SERVICE_UUID] });
    if(connectToken!==myToken) return;
    try{ bleDevice?.removeEventListener('gattserverdisconnected', onDisconnected);}catch(_){}
    bleDevice=dev; bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
    const server=await dev.gatt.connect(); if(connectToken!==myToken) return;
    const service=await server.getPrimaryService(SERVICE_UUID);
    const {w,n,wwo}=await pickWriteCharacteristic(service);
    if(!w) throw new Error('Ïì∞Í∏∞ ÌäπÏÑ±ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
    writeChar=w; notifyChar=n; canWriteWO=wwo; bleServer=server; bleService=service;
    if(notifyChar){ try{ await notifyChar.startNotifications(); notifyChar.addEventListener('characteristicvaluechanged',ev=>{ const v=new TextDecoder().decode(ev.target.value); log('‚¨ÖÔ∏è '+v.trim()); }); }catch(_){ } }
    if(connectToken!==myToken) return;
    setConnected(true); log('‚úÖ Ïó∞Í≤∞: '+(dev.name||'(Ïù¥Î¶Ñ ÏóÜÏùå)')+(canWriteWO?' (WO)':''));
  }catch(e){ console.error(e); log('‚ùå Ïó∞Í≤∞ Ïã§Ìå®: '+e); setConnected(false); writeChar=notifyChar=null; }
}
function disconnectBLE(){
  setRunning(false); txQueue.length=0; ++connectToken;
  try{ bleDevice?.gatt?.disconnect(); }catch(_){}
  setConnected(false);
}
btnConnect.onclick = ()=>{ isConnected ? disconnectBLE() : connectBLE(); };

/* Ïã§Ìñâ Î£®ÌîÑ */
function blocksToProgram(){
  const starts=ws.getBlocksByType('xrobo_start',true);
  let entry=null, startChain=null;
  if(starts.length){ entry=starts[0]; startChain=entry.getNextBlock(); }
  else{
    const tops=ws.getTopBlocks(true);
    for(const b of tops){ if(!b.outputConnection&&(b.nextConnection||b.statementInputCount>0)) { entry=b; startChain=b; break; } }
  }
  if(!entry) return [];
  const prog=[];
  function walkNode(b){
    if(!b) return;
    switch(b.type){
      case 'motor12_dd':{
        const v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS');
        prog.push({t:'C',s:`M12 ${v1} ${v2} ${ms}`}); if(ms>0) prog.push({t:'W',ms}); break; }
      case 'motor12_in':{
        const v1=numFromInput(b,'M1',0),v2=numFromInput(b,'M2',0),ms=numFromInput(b,'MS',0);
        prog.push({t:'C',s:`M12 ${Math.round(v1)} ${Math.round(v2)} ${Math.round(ms)}`}); if(ms>0) prog.push({t:'W',ms}); break; }
      case 'servo_dd':{
        const S=b.getFieldValue('OUT').replace('OUT','S'); const A=Math.max(0,Math.min(180,+b.getFieldValue('ANG')));
        prog.push({t:'C',s:`SV ${S} ${A}`}); break; }
      case 'led_ctrl':{
        const t=b.getFieldValue('TGT'); const v=b.getFieldValue('VAL'); let ch=0; if(t!=='CPU'){ const m=t.match(/^OUT(\d)$/); ch=m?parseInt(m[1],10):0; }
        prog.push({t:'C',s:`LED ${ch} ${v}`}); break; }
      case 'repeat_forever':{
        const inner=[]; let n=b.getInputTargetBlock('DO'); while(n){ inner.push(n); n=n.getNextBlock(); }
        prog.push({t:'L',body:inner}); break; }
      case 'controls_repeat_ext':{
        const times=Math.max(0, numFromInput(b,'TIMES',1));
        const inner=[]; let n2=b.getInputTargetBlock('DO'); while(n2){ inner.push(n2); n2=n2.getNextBlock(); }
        prog.push({t:'F',count:times,body:inner}); break; }
      case 'wait_seconds':{
        const s=numFromInput(b,'SEC',1); if(s>0) prog.push({t:'W',ms:s*1000}); break; }
    }
    walkNode(b.getNextBlock());
  }
  walkNode(startChain);
  // normalize
  const out=[];
  for(const x of prog){
    if(x.t==='C'){ const p=out[out.length-1]; if(p && p.t==='C' && p.s===x.s) continue; }
    if(x.t==='W'){ const p=out[out.length-1]; if(p && p.t==='W'){ p.ms+=x.ms; continue; } }
    out.push(x);
  }
  return out;
}

async function runProgram(){
  const prog = blocksToProgram();
  if(!prog.length){ alert('Ïã§ÌñâÌï† Î∏îÎ°ùÏù¥ ÏóÜÏäµÎãàÎã§.\\n\"XROBO start\" ÎòêÎäî ÏµúÏÉÅÎã® Ïä§ÌÉùÏùÑ Î∞∞ÏπòÌïòÏÑ∏Ïöî.'); return; }
  setRunning(true);
  const myRunId = ++runToken;
  const canceled = ()=> (myRunId !== runToken) || !isRunning || !isConnected;

  async function emit(list){
    for(let i=0;i<list.length;i++){
      if(canceled()) return;
      const ins = list[i];
      if(ins.t==='C'){
        sendLine(ins.s);
        await new Promise(r=>setTimeout(r,10));
      }else if(ins.t==='W'){
        let remain = ins.ms|0;
        while(remain>0 && !canceled()){ const slice=Math.min(remain,50); await new Promise(r=>setTimeout(r,slice)); remain-=slice; }
      }else if(ins.t==='F'){
        for(let k=0;k<ins.count;k++){ if(canceled()) return; await emit(ins.body); }
      }else if(ins.t==='L'){
        while(!canceled()){ await emit(ins.body); }
      }
    }
  }

  try{ await emit(prog); }
  catch(e){ log('‚ö†Ô∏è Ïã§Ìñâ Ïò§Î•ò: '+e); }
  finally{ if(!canceled()) setRunning(false); }
}

btnRun.onclick = async ()=>{
  if(!isConnected){ alert('Î®ºÏ†Ä BLE Ïó∞Í≤∞!'); return; }
  if(!isRunning){ await runProgram(); }
  else{ runToken++; setRunning(false); txQueue.length=0; try{ if(writeChar) sendLine('S'); }catch(_){ } }
};

/* Ìå®ÎÑê/Ï†ÑÏ≤¥ÌôîÎ©¥ */
document.getElementById('panelHandle').addEventListener('click', ()=>{ document.body.classList.toggle('panel-collapsed'); setTimeout(()=>Blockly.svgResize(ws),60); });
const fsBtn=document.getElementById('fsBtn');
async function enterFS(){ const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); }
async function exitFS(){ if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }
function applyHeaderHeight(){ const px = document.getElementById('appHeader').offsetHeight || 64; document.documentElement.style.setProperty('--headerH', px+'px'); setTimeout(()=>Blockly.svgResize(ws),60); }
fsBtn.onclick=async()=>{ if(document.fullscreenElement) await exitFS(); else await enterFS(); };
window.addEventListener('resize', applyHeaderHeight); document.addEventListener('fullscreenchange', applyHeaderHeight); applyHeaderHeight();
</script>
</body>
</html>
