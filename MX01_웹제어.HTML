<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MX-01 BLE ë¦¬ëª¨ì»¨</title>
<style>
  body{font-family:system-ui,sans-serif;margin:16px;line-height:1.45}
  button{padding:10px 14px;border:0;border-radius:10px;margin:6px 6px 6px 0;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  #connect{background:#2563eb;color:#fff} #disconnect{background:#475569;color:#fff}
  #on{background:#16a34a;color:#fff} #off{background:#ef4444;color:#fff}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;font-size:12px}
  .ok{background:#d1fae5} .log{white-space:pre-wrap;background:#f7f7f7;border-radius:8px;padding:10px;font-family:ui-monospace,monospace;font-size:13px;margin-top:12px;max-height:160px;overflow:auto}
  input{padding:8px 10px;border:1px solid #ddd;border-radius:8px}
</style>
</head>
<body>
<h2>MX-01 BLE ë¦¬ëª¨ì»¨ (ì„œë¹„ìŠ¤ 0xFFF0 / ê¸°ë³¸ Write 0xFFF3)</h2>
<p>HTTPSì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”. ì¥ì¹˜ëª… í”„ë¦¬í”½ìŠ¤/UUIDê°€ ë‹¤ë¥¸ íŒì›¨ì–´ë„ ìë™ íƒì§€ ë¡œì§ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>

<div>
  <button id="connect">ğŸ”— ì—°ê²°</button>
  <button id="disconnect" disabled>âŒ í•´ì œ</button>
  <span id="status" class="badge">ë¯¸ì—°ê²°</span>
</div>

<div style="margin:8px 0">
  <label>ì´ë¦„ í”„ë¦¬í”½ìŠ¤(ì˜µì…˜): <input id="namePrefix" value="MX" placeholder="MX / Arduino ë“±"></label>
</div>

<div>
  <button id="on"  disabled>ğŸ’¡ ON ("1")</button>
  <button id="off" disabled>ğŸ’¤ OFF ("0")</button>
</div>

<div class="log" id="log"></div>

<script>
const DEFAULT_SERVICE = 0xFFF0;   // ë§¤ë‰´ì–¼ ê¸°ë³¸ ì„œë¹„ìŠ¤ (íˆ¬ëª…ì „ì†¡) â€” ë¬¸ì„œ ì°¸ê³ 
let device, server, service, writeChar, notifyChar;

const $ = id => document.getElementById(id);
const log = m => { const L=$("log"); L.textContent += m + "\n"; L.scrollTop=L.scrollHeight; }
const setUI = on => {
  $("status").textContent = on ? "ì—°ê²°ë¨" : "ë¯¸ì—°ê²°";
  $("status").className = on ? "badge ok" : "badge";
  $("disconnect").disabled = !on;
  $("on").disabled = !on; $("off").disabled = !on;
};

function enc(s){ return new TextEncoder().encode(s); }

async function connectBLE(){
  if(!navigator.bluetooth){ alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
  try{
    const filters = [{ services: [DEFAULT_SERVICE] }];
    const pref = $("namePrefix").value.trim(); if(pref) filters.push({ namePrefix: pref });

    log("â³ ìŠ¤ìº” ì¤‘...");
    device = await navigator.bluetooth.requestDevice({ filters, optionalServices: [DEFAULT_SERVICE] });
    device.addEventListener("gattserverdisconnected", ()=>{ setUI(false); log("ğŸ”Œ í•´ì œë¨"); });

    server = await device.gatt.connect();
    log("ğŸ”Œ GATT ì—°ê²° ì™„ë£Œ");

    service = await server.getPrimaryService(DEFAULT_SERVICE);

    // 1) ìš°ì„  ê¸°ë³¸ Write(0xFFF3)/Notify(0xFFF4) ì‹œë„
    try { writeChar = await service.getCharacteristic(0xFFF3); } catch(_) {}
    try { notifyChar= await service.getCharacteristic(0xFFF4); } catch(_) {}

    // 2) ì‹¤íŒ¨ ì‹œ ìë™ íƒì§€: write/writeWithoutResponse/notify ì†ì„± ê²€ì‚¬
    if(!writeChar || (notifyChar==null)){
      const chars = await service.getCharacteristics();
      for(const ch of chars){
        const p = ch.properties;
        if(!writeChar && (p.write || p.writeWithoutResponse)) writeChar = ch;
        if(!notifyChar && p.notify) notifyChar = ch;
      }
    }

    if(!writeChar) throw new Error("write ê°€ëŠ¥í•œ ìºë¦­í„°ë¦¬ìŠ¤í‹±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

    if(notifyChar){
      await notifyChar.startNotifications();
      notifyChar.addEventListener("characteristicvaluechanged", ev=>{
        const v = new TextDecoder().decode(ev.target.value);
        log("â¬…ï¸ Notify: " + v);
      });
    }

    setUI(true);
    log("âœ… ì¤€ë¹„ ì™„ë£Œ");
  }catch(e){ console.error(e); log("âŒ ì—°ê²° ì‹¤íŒ¨: " + e); setUI(false); }
}

async function send(val){
  if(!writeChar) return alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
  try{ await writeChar.writeValue(enc(val)); log(`â¡ï¸ ì „ì†¡: "${val}"`); }
  catch(e){ console.error(e); log("âš ï¸ ì „ì†¡ ì‹¤íŒ¨: " + e); }
}

$("connect").onclick = connectBLE;
$("disconnect").onclick = ()=>{ try{ device?.gatt?.disconnect(); }catch(_){} setUI(false); };
$("on").onclick  = ()=>send("1");
$("off").onclick = ()=>send("0");
setUI(false);
</script>
</body>
</html>
